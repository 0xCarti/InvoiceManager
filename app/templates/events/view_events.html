{% extends 'base.html' %}
{% from 'macros/column_visibility.html' import column_visibility_dropdown %}
{% block content %}
<h2>Events</h2>
<div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center gap-2 mb-3">
    <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEventModal">Create Event</button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">Filter</button>
    </div>
    <div class="text-sm-end">
        {{ column_visibility_dropdown(
            table_id='events-table',
            storage_key='eventsTableColumnVisibility',
            columns=[
                {'id': 'toggle-event-name', 'target': 'col-event-name', 'label': 'Name', 'checked': True},
                {'id': 'toggle-event-type', 'target': 'col-event-type', 'label': 'Type', 'checked': True},
                {'id': 'toggle-event-start', 'target': 'col-event-start', 'label': 'Start', 'checked': True},
                {'id': 'toggle-event-end', 'target': 'col-event-end', 'label': 'End', 'checked': True},
                {'id': 'toggle-event-closed', 'target': 'col-event-closed', 'label': 'Closed', 'checked': True},
                {'id': 'toggle-event-actions', 'target': 'col-event-actions', 'label': 'Actions', 'checked': True},
            ]
        ) }}
    </div>
</div>
<div class="table-responsive">
<table class="table mt-3 sortable" id="events-table">
    <thead>
        <tr>
            <th scope="col" class="col-event-name">Name</th>
            <th scope="col" class="col-event-type">Type</th>
            <th scope="col" class="col-event-start">Start</th>
            <th scope="col" class="col-event-end">End</th>
            <th scope="col" class="col-event-closed">Closed</th>
            <th scope="col" class="col-event-actions">Actions</th>
        </tr>
    </thead>
    <tbody id="events-table-body">
        {% include 'events/_events_table.html' %}
    </tbody>
</table>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Filter Events</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="filterForm">
        <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="mb-3">
                <label for="filter-type" class="form-label">Event Type</label>
                <select name="type" id="filter-type" class="form-control">
                    <option value="">All Types</option>
                    {% for val, label in event_types %}
                        <option value="{{ val }}" {% if filter_values.type == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="filter-name-contains" class="form-label">Name Contains</label>
                <input type="text" name="name_contains" id="filter-name-contains" class="form-control" value="{{ filter_values.name_contains }}" placeholder="e.g. Summer" />
            </div>
            <div class="mb-3">
                <label for="filter-name-not-contains" class="form-label">Name Does Not Contain</label>
                <input type="text" name="name_not_contains" id="filter-name-not-contains" class="form-control" value="{{ filter_values.name_not_contains }}" placeholder="e.g. Test" />
            </div>
            <div class="row g-2 mb-3">
                <div class="col-sm-6">
                    <label for="filter-start-date-from" class="form-label">Start Date From</label>
                    <input type="date" name="start_date_from" id="filter-start-date-from" class="form-control" value="{{ filter_values.start_date_from }}" />
                </div>
                <div class="col-sm-6">
                    <label for="filter-start-date-to" class="form-label">Start Date To</label>
                    <input type="date" name="start_date_to" id="filter-start-date-to" class="form-control" value="{{ filter_values.start_date_to }}" />
                </div>
            </div>
            <div class="row g-2 mb-3">
                <div class="col-sm-6">
                    <label for="filter-end-date-from" class="form-label">End Date From</label>
                    <input type="date" name="end_date_from" id="filter-end-date-from" class="form-control" value="{{ filter_values.end_date_from }}" />
                </div>
                <div class="col-sm-6">
                    <label for="filter-end-date-to" class="form-label">End Date To</label>
                    <input type="date" name="end_date_to" id="filter-end-date-to" class="form-control" value="{{ filter_values.end_date_to }}" />
                </div>
            </div>
            <div class="mb-3">
                <label for="filter-closed-status" class="form-label">Status</label>
                <select name="closed_status" id="filter-closed-status" class="form-control">
                    <option value="" {% if not filter_values.closed_status %}selected{% endif %}>All</option>
                    <option value="open" {% if filter_values.closed_status == 'open' %}selected{% endif %}>Open</option>
                    <option value="closed" {% if filter_values.closed_status == 'closed' %}selected{% endif %}>Closed</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Apply</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Event Modal -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createEventForm">
        <div class="modal-body">
          {{ create_form.csrf_token }}
          {{ create_form.name.label }} {{ create_form.name(class='form-control') }}
          {{ create_form.start_date.label }} {{ create_form.start_date(class='form-control') }}
          {{ create_form.end_date.label }} {{ create_form.end_date(class='form-control') }}
          {{ create_form.event_type.label }} {{ create_form.event_type(class='form-control') }}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script nonce="{{ csp_nonce }}">
$(function(){
    $('#filterForm').on('submit', function(e){
        e.preventDefault();
        $.post('{{ url_for('event.filter_events_ajax') }}', $(this).serialize(), function(data){
            $('#events-table-body').html(data);
            const modalEl = document.getElementById('filterModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) { modal.hide(); }
        });
    });
    $('#createEventForm').on('submit', function(e){
        e.preventDefault();
        $.post('{{ url_for('event.create_event_ajax') }}', $(this).serialize(), function(row){
            $('#events-table-body').append(row);
            const modalEl = document.getElementById('createEventModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) { modal.hide(); }
            $('#createEventForm')[0].reset();
        });
    });
});
</script>
{% endblock %}
