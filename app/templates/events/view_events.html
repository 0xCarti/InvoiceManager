{% extends 'base.html' %}
{% from 'macros/column_visibility.html' import column_visibility_dropdown %}
{% block content %}
<h2>Events</h2>
<div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center gap-2 mb-3">
    <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEventModal">Create Event</button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">Filter</button>
    </div>
    <div class="text-sm-end">
        {{ column_visibility_dropdown(
            table_id='events-table',
            storage_key='eventsTableColumnVisibility',
            columns=[
                {'id': 'toggle-event-name', 'target': 'col-event-name', 'label': 'Name', 'checked': True},
                {'id': 'toggle-event-type', 'target': 'col-event-type', 'label': 'Type', 'checked': True},
                {'id': 'toggle-event-start', 'target': 'col-event-start', 'label': 'Start', 'checked': True},
                {'id': 'toggle-event-end', 'target': 'col-event-end', 'label': 'End', 'checked': True},
                {'id': 'toggle-event-estimated-sales', 'target': 'col-event-estimated-sales', 'label': 'Estimated Sales', 'checked': True},
                {'id': 'toggle-event-closed', 'target': 'col-event-closed', 'label': 'Closed', 'checked': True},
                {'id': 'toggle-event-actions', 'target': 'col-event-actions', 'label': 'Actions', 'checked': True},
            ]
        ) }}
    </div>
</div>
<div class="table-responsive">
<table class="table mt-3 sortable" id="events-table">
    <thead>
        <tr>
            <th scope="col" class="col-event-name">Name</th>
            <th scope="col" class="col-event-type">Type</th>
            <th scope="col" class="col-event-start">Start</th>
            <th scope="col" class="col-event-end">End</th>
            <th scope="col" class="col-event-estimated-sales">Estimated Sales</th>
            <th scope="col" class="col-event-closed">Closed</th>
            <th scope="col" class="col-event-actions">Actions</th>
        </tr>
    </thead>
    <tbody id="events-table-body">
        {% include 'events/_events_table.html' %}
    </tbody>
</table>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Filter Events</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="filterForm">
        <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <select name="type" class="form-control">
                <option value="">All Types</option>
                {% for val, label in event_types %}
                    <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Apply</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Event Modal -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createEventForm">
        <div class="modal-body">
          {{ create_form.csrf_token }}
          {{ create_form.name.label }} {{ create_form.name(class='form-control') }}
          {{ create_form.start_date.label }} {{ create_form.start_date(class='form-control') }}
          {{ create_form.end_date.label }} {{ create_form.end_date(class='form-control') }}
          {{ create_form.event_type.label }} {{ create_form.event_type(class='form-control') }}
          {{ create_form.estimated_sales.label }} {{ create_form.estimated_sales(class='form-control', placeholder='Optional') }}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script nonce="{{ csp_nonce }}">
$(function(){
    $('#filterForm').on('submit', function(e){
        e.preventDefault();
        $.post('{{ url_for('event.filter_events_ajax') }}', $(this).serialize(), function(data){
            $('#events-table-body').html(data);
            const modalEl = document.getElementById('filterModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) { modal.hide(); }
        });
    });
    $('#createEventForm').on('submit', function(e){
        e.preventDefault();
        $.post('{{ url_for('event.create_event_ajax') }}', $(this).serialize(), function(row){
            $('#events-table-body').append(row);
            const modalEl = document.getElementById('createEventModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) { modal.hide(); }
            $('#createEventForm')[0].reset();
        });
    });
});
</script>
{% endblock %}
