{% extends 'base.html' %}
{% block content %}
<h2>Upload Terminal Sales for {{ event.name }}</h2>

{% set resolving_issues = current_issue is defined %}
{% set issue_total = issue_total if issue_total is defined else 0 %}
{% set active_stage = active_stage if active_stage is defined else 'locations' %}
{% set stage_index = 1 %}
{% if active_stage == 'products' %}
    {% set stage_index = 2 %}
{% elif active_stage == 'issues' %}
    {% set stage_index = 3 %}
{% endif %}
{% set countable_products = countable_products if countable_products is defined else [] %}
{% set countable_item_options = countable_item_options if countable_item_options is defined else [] %}
{% set countable_selection_errors = countable_selection_errors if countable_selection_errors is defined else [] %}

{% if mapping_payload %}
    <div class="mb-4" aria-label="Terminal sales upload steps">
        {% set steps = [
            {'number': 1, 'label': 'Map Locations'},
            {'number': 2, 'label': 'Resolve Products'},
            {'number': 3, 'label': 'Finalize Issues'}
        ] %}
        <div class="d-flex flex-wrap align-items-center gap-3">
            {% for step in steps %}
                {% set is_active = step.number == stage_index %}
                {% set is_complete = step.number < stage_index %}
                {% set badge_classes = 'badge rounded-pill me-2' %}
                {% if is_active %}
                    {% set badge_classes = badge_classes ~ ' bg-primary' %}
                {% elif is_complete %}
                    {% set badge_classes = badge_classes ~ ' bg-success' %}
                {% else %}
                    {% set badge_classes = badge_classes ~ ' bg-secondary' %}
                {% endif %}
                {% set label_classes = 'mb-0' %}
                {% if is_active %}
                    {% set label_classes = label_classes ~ ' fw-semibold text-primary' %}
                {% elif is_complete %}
                    {% set label_classes = label_classes ~ ' text-success' %}
                {% else %}
                    {% set label_classes = label_classes ~ ' text-muted' %}
                {% endif %}
                <div class="d-flex align-items-center">
                    <span class="{{ badge_classes }}">{{ step.number }}</span>
                    <span class="{{ label_classes }}">{{ step.label }}</span>
                </div>
            {% endfor %}
        </div>
    </div>
    <div class="alert alert-info">
        {% if resolving_issues %}
            <p class="mb-0">
                Resolve the discrepancies detected in the uploaded terminal sales
                before importing them. Each location must be handled separately.
            </p>
        {% elif active_stage == 'products' %}
            <p class="mb-0">
                Match any unknown products from the uploaded file to products in
                the app or choose to skip them. Use the buttons below to update
                each product, or go back to adjust your location selections.
            </p>
        {% else %}
            <p class="mb-0">
                Review the sales locations detected in the uploaded file and link
                them to the open event locations below. A blank selection will skip
                updating that event location.
            </p>
        {% endif %}
    </div>
    {% if mapping_filename %}
        <p><strong>Source file:</strong> {{ mapping_filename }}</p>
    {% endif %}
    {% if sales_location_names %}
        {% if not resolving_issues and active_stage == 'locations' %}
            <div class="mb-3">
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        data-role="toggle-sales-summary"
                        data-show-text="Show sales summary"
                        data-hide-text="Hide sales summary"
                        aria-controls="sales-summary-panel"
                        aria-expanded="false">
                    Show sales summary
                </button>
            </div>
        {% endif %}
        <div class="mb-4 {% if not resolving_issues %}d-none{% endif %}"
             id="sales-summary-panel"
             data-role="sales-summary-panel">
            {% if not resolving_issues %}
                <div class="alert alert-secondary">
                    <strong>Detected sales locations:</strong>
                    {{ sales_location_names | join(', ') }}
                </div>
            {% endif %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th scope="col">Sales Location</th>
                            <th scope="col">Total Quantity</th>
                            <th scope="col">Total Amount</th>
                            <th scope="col">Products</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for location_name in sales_location_names %}
                            {% set data = sales_summary[location_name] %}
                            <tr>
                                <th scope="row">{{ location_name }}</th>
                                <td>{{ '%.2f'|format(data.total) }}</td>
                                <td>
                                    {% if data.total_amount %}
                                        {{ '%.2f'|format(data.total_amount) }}
                                    {% else %}
                                        &mdash;
                                    {% endif %}
                                </td>
                                <td>
                                    <ul class="mb-0 ps-3">
                                        {% for product_name, info in data.products.items() %}
                                            <li>
                                                {{ product_name }} &mdash; {{ '%.2f'|format(info.quantity) }}
                                                {% if info.prices %}
                                                    @ $
                                                    {% for price in info.prices %}
                                                        {{ '%.2f'|format(price) }}{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                                {% if info.amount %}
                                                    <span class="text-muted">(Total ${{ '%.2f'|format(info.amount) }})</span>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    {% if resolving_issues %}
        {% set current_step = issue_index + 1 %}
        {% set unresolved_prices = current_issue.price_issues | selectattr('resolution', 'equalto', None) | list %}
        {% set unresolved_menu = current_issue.menu_issues | selectattr('resolution', 'equalto', None) | list %}
        {% set unresolved_total = unresolved_prices|length + unresolved_menu|length %}
        <div class="alert alert-warning">
            <p class="mb-1">
                Resolving issues for <strong>{{ current_issue.location_name }}</strong>
                (file location "{{ current_issue.sales_location }}").
            </p>
            <p class="mb-0">
                Location {{ current_step }} of {{ issue_total }}. Remaining locations:
                {{ remaining_locations if remaining_locations > 0 else 0 }}.
            </p>
        </div>
        <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="step" value="resolve">
            <input type="hidden" name="payload" value="{{ mapping_payload }}">
            <input type="hidden" name="state_token" value="{{ state_token }}">
            <input type="hidden" name="mapping_filename" value="{{ mapping_filename }}">
            {% if current_issue.price_issues %}
                <div class="card mb-3">
                    <div class="card-header">Price Differences</div>
                    <div class="card-body">
                        {% for issue in current_issue.price_issues %}
                            <div class="mb-3">
                                <h6 class="mb-1">{{ issue.product }}</h6>
                                <p class="mb-2">
                                    Terminal sales price:
                                    {% for price in issue.file_prices %}
                                        ${{ '%.2f'|format(price) }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                    &mdash; App price: ${{ '%.2f'|format(issue.app_price) }}
                                </p>
                                {% if issue.resolution == 'update' %}
                                    <span class="badge bg-success">Will update app price to ${{ '%.2f'|format(issue.target_price) }}</span>
                                {% elif issue.resolution == 'skip' %}
                                    <span class="badge bg-secondary">Keeping existing app price</span>
                                {% else %}
                                    <div class="btn-group" role="group" aria-label="Price resolution">
                                        <button type="submit" class="btn btn-sm btn-primary" name="action" value="price:{{ issue.product_id }}:update">
                                            Use terminal price
                                        </button>
                                        <button type="submit" class="btn btn-sm btn-outline-secondary" name="action" value="price:{{ issue.product_id }}:skip">
                                            Keep app price
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            {% if current_issue.menu_issues %}
                <div class="card mb-3">
                    <div class="card-header">Menu Availability</div>
                    <div class="card-body">
                        {% for issue in current_issue.menu_issues %}
                            <div class="mb-3">
                                <h6 class="mb-1">{{ issue.product }}</h6>
                                <p class="mb-2">
                                    This product is not on the menu{% if issue.menu_name %} ({{ issue.menu_name }}){% endif %}
                                    for {{ current_issue.location_name }}.
                                </p>
                                {% if issue.resolution == 'add' %}
                                    <span class="badge bg-success">Will add product to the menu</span>
                                {% elif issue.resolution == 'skip' %}
                                    <span class="badge bg-secondary">Will leave menu unchanged</span>
                                {% else %}
                                    <div class="btn-group" role="group" aria-label="Menu resolution">
                                        <button type="submit" class="btn btn-sm btn-primary" name="action" value="menu:{{ issue.product_id }}:add">
                                            Add to menu
                                        </button>
                                        <button type="submit" class="btn btn-sm btn-outline-secondary" name="action" value="menu:{{ issue.product_id }}:skip">
                                            Skip for now
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
            <div class="d-flex align-items-center mb-3">
                <button type="submit" class="btn btn-primary" name="action" value="next_location" {% if unresolved_total > 0 %}disabled{% endif %}>
                    {% if remaining_locations > 0 %}
                        Next Location
                    {% else %}
                        Finish Import
                    {% endif %}
                </button>
                <button type="submit"
                        class="btn btn-outline-secondary ms-2"
                        name="action"
                        value="back_to_mapping">
                    Back to Mapping
                </button>
                {% if unresolved_total > 0 %}
                    <span class="ms-3 text-danger">Resolve all issues above to continue.</span>
                {% endif %}
            </div>
            <a href="{{ url_for('event.upload_terminal_sales', event_id=event.id) }}" class="btn btn-link">Start Over</a>
        </form>
    {% else %}
        <form method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="step" value="map">
            <input type="hidden" name="payload" value="{{ mapping_payload }}">
            <input type="hidden" name="stage" value="{{ active_stage }}">
            {% if assignment_errors %}
                <div class="alert alert-danger">
                    <ul class="mb-0 ps-3">
                        {% for message in assignment_errors %}
                            <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            {% if product_resolution_required and active_stage == 'products' %}
                <input type="hidden" name="product-resolution-step" value="1">
                {% if countable_products %}
                    <input type="hidden" name="countable-selection-step" value="1">
                {% endif %}
                <div class="alert alert-warning">
                    <p class="mb-2">
                        We couldn't automatically match every product in the terminal
                        sales file. Please select the matching product from the app
                        for each unknown entry below.
                    </p>
                    {% if resolution_errors %}
                        <ul class="mb-0 ps-3">
                            {% for message in resolution_errors %}
                                <li>{{ message }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                {% set search_options = product_search_options|default([], true) %}
                {% set skip_value = skip_selection_value|default('__skip__') %}
                {% set create_value = create_selection_value|default('__create__') %}
                <div class="card mb-3">
                    <div class="card-header">Match Unknown Products</div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            Start typing to search by product name, then choose the matching product
                            or use the buttons to skip or create a new product.
                        </p>
                        <datalist id="terminal-product-options">
                            {% for option in search_options %}
                                <option value="{{ option.value }}" data-id="{{ option.id }}" label="{{ option.label }}"></option>
                            {% endfor %}
                        </datalist>
                        {% for product in unresolved_products %}
                            {% set selected_value = product.selected|default('', true) %}
                            {% set selected_value = '%s' % selected_value %}
                            {% set selected_display = '' %}
                            {% if selected_value and selected_value not in [skip_value, create_value] %}
                                {% set match = (search_options | selectattr('id', 'equalto', selected_value) | list) %}
                                {% if match %}
                                    {% set selected_display = match[0].value %}
                                {% endif %}
                            {% endif %}
                            <div class="mb-3 terminal-product-mapping"
                                 data-terminal-product-mapping
                                 data-skip-value="{{ skip_value }}"
                                 data-create-value="{{ create_value }}">
                                <label class="form-label" for="{{ product.field }}-search">
                                    {{ product.name }}
                                </label>
                                <div class="input-group">
                                    <input type="search"
                                           class="form-control"
                                           id="{{ product.field }}-search"
                                           name="{{ product.field }}-search"
                                           list="terminal-product-options"
                                           data-role="product-search-input"
                                           placeholder="Start typing to search by product name..."
                                           value="{{ selected_display }}">
                                    <button type="button" class="btn btn-outline-secondary" data-action="clear">Clear</button>
                                </div>
                                <input type="hidden"
                                       name="{{ product.field }}"
                                       id="{{ product.field }}"
                                       value="{{ selected_value }}"
                                       data-role="product-value">
                                <div class="btn-group mt-2" role="group" aria-label="Mapping actions">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-action="skip">
                                        Skip this product
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" data-action="create">
                                        Create a new product
                                    </button>
                                </div>
                                <div class="form-text" data-role="selection-status"></div>
                                <div class="form-text text-danger d-none" data-role="selection-error">
                                    Select a product from the suggestions or choose Skip/Create.
                                </div>
                                {% if product.price is not none %}
                                    <div class="form-text">
                                        Creating a new product will use the sale price of ${{ '%.2f'|format(product.price) }} from the uploaded file.
                                    </div>
                                {% else %}
                                    <div class="form-text">
                                        Creating a new product will use the uploaded sale price when available; otherwise the price will default to $0.00.
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% if countable_products %}
                    <div class="card mb-3">
                        <div class="card-header">Assign Countable Items</div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                Choose the countable inventory item that should be added to the
                                stand sheet when creating each new product.
                            </p>
                            {% if countable_selection_errors %}
                                <div class="alert alert-danger" role="alert">
                                    <ul class="mb-0 ps-3">
                                        {% for message in countable_selection_errors %}
                                            <li>{{ message }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            {% for entry in countable_products %}
                                <div class="mb-3">
                                    <label class="form-label" for="{{ entry.field }}">
                                        {{ entry.product_name }}
                                    </label>
                                    <select class="form-select"
                                            id="{{ entry.field }}"
                                            name="{{ entry.field }}"
                                            required>
                                        <option value="">
                                            Select a countable item to track on the stand sheet...
                                        </option>
                                        {% for option in countable_item_options %}
                                            <option value="{{ option.id }}"
                                                    {% if option.id == entry.selected %}selected{% endif %}>
                                                {{ option.label }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% elif active_stage == 'products' %}
                <div class="alert alert-success">
                    <p class="mb-0">All products in the uploaded file have been matched automatically.</p>
                </div>
            {% endif %}
            {% if sales_location_names %}
                <div class="card mb-3 {% if active_stage != 'locations' %}d-none{% endif %}">
                    <div class="card-header">Manage Terminal Sales Locations</div>
                    <div class="card-body">
                        <p class="mb-3">
                            Select any locations from the uploaded file that should be
                            ignored for this import.
                        </p>
                        {% if unassigned_sales_locations %}
                            <div class="alert alert-warning">
                                <strong>Unassigned locations:</strong>
                                {{ unassigned_sales_locations | join(', ') }}
                            </div>
                        {% endif %}
                        {% for location_name in sales_location_names %}
                            {% set checkbox_id = 'ignore-location-' ~ loop.index %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox"
                                       id="{{ checkbox_id }}"
                                       name="ignored_locations"
                                       value="{{ location_name }}"
                                       {% if location_name in ignored_sales_locations %}checked{% endif %}>
                                <label class="form-check-label" for="{{ checkbox_id }}">
                                    Ignore <strong>{{ location_name }}</strong>
                                    {% if location_name in assigned_sales_locations %}
                                        <span class="badge bg-success ms-2">Linked</span>
                                    {% elif location_name in unassigned_sales_locations %}
                                        <span class="badge bg-warning text-dark ms-2">Unassigned</span>
                                    {% endif %}
                                </label>
                            </div>
                        {% endfor %}
                        <div class="form-text">
                            Ignored locations and their products will not be imported.
                        </div>
                    </div>
                </div>
            {% endif %}
            {% if active_stage == 'products' %}
                <div class="card mb-3">
                    <div class="card-header">Location Mapping Summary</div>
                    <div class="card-body">
                        {% if ignored_sales_locations %}
                            <p class="mb-2">
                                <strong>Ignored locations:</strong>
                                {{ ignored_sales_locations | join(', ') }}
                            </p>
                        {% endif %}
                        {% if open_locations %}
                            <ul class="mb-0 ps-3">
                                {% for el in open_locations %}
                                    {% set selected_location = default_mapping.get(el.id) %}
                                    <li>
                                        <strong>{{ el.location.name }}</strong>
                                        {% if selected_location %}
                                            &rarr; {{ selected_location }}
                                        {% else %}
                                            <span class="text-muted">&rarr; Skipped</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="mb-0 text-muted">There are no open event locations to link.</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            {% if open_locations %}
                <div class="card mb-3 {% if active_stage != 'locations' %}d-none{% endif %}">
                    <div class="card-header">Link Event Locations</div>
                    <div class="card-body">
                        {% for el in open_locations %}
                            <div class="mb-3">
                                <label class="form-label" for="mapping-{{ el.id }}">
                                    {{ el.location.name }}
                                </label>
                                <select class="form-select" id="mapping-{{ el.id }}" name="mapping-{{ el.id }}">
                                    <option value="">Skip</option>
                                    {% for location_name in sales_location_names %}
                                        <option value="{{ location_name }}" {% if default_mapping[el.id] == location_name %}selected{% endif %}>
                                            {{ location_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="d-flex flex-wrap align-items-center">
                    {% if active_stage == 'locations' %}
                        <button type="submit" class="btn btn-primary" name="navigate" value="next">
                            Next: Resolve Products
                        </button>
                        <a href="{{ url_for('event.upload_terminal_sales', event_id=event.id) }}"
                           class="btn btn-outline-secondary ms-2">
                            Start Over
                        </a>
                    {% else %}
                        <button type="submit"
                                class="btn btn-outline-secondary"
                                name="navigate"
                                value="back">
                            Back to Locations
                        </button>
                        <button type="submit"
                                class="btn btn-primary ms-2"
                                name="navigate"
                                value="finish">
                            Finish
                        </button>
                        <a href="{{ url_for('event.upload_terminal_sales', event_id=event.id) }}"
                           class="btn btn-link ms-2">
                            Start Over
                        </a>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-warning">
                    There are no open locations for this event available for mapping.
                </div>
                <a href="{{ url_for('event.view_event', event_id=event.id) }}" class="btn btn-secondary">Back to Event</a>
            {% endif %}
        </form>
    {% endif %}
{% else %}
    <form method="post" enctype="multipart/form-data" class="mb-4">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            {{ form.program.label(class="form-label") }}
            {{ form.program(class="form-select") }}
            <div class="form-text">Select the point of sale system the sales file was exported from.</div>
        </div>
        <div class="mb-3">
            {{ form.file.label(class="form-label") }}
            {{ form.file(class="form-control") }}
            <div class="form-text">Accepted format: IdealPOS Excel export (.xls).</div>
        </div>
        {{ form.submit(class="btn btn-primary") }}
    </form>
    <div class="card">
        <div class="card-body">
            <h5 class="card-title mb-3">IdealPOS sales export example</h5>
            <p class="mb-2">File type: <span class="fw-semibold">Excel spreadsheet (.xls)</span></p>
            <p class="mb-3">The IdealPOS export groups sales by location. Each location is followed by item rows with the columns shown below (values are taken from <code>sales(1).xls</code>).</p>
            <div class="table-responsive">
                <table class="table table-sm table-bordered mb-3 text-nowrap">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Product Code</th>
                            <th scope="col">Product Description</th>
                            <th scope="col" class="text-end">Unit Price (incl. tax)</th>
                            <th scope="col" class="text-end">Unit Tax</th>
                            <th scope="col" class="text-end">Quantity Sold</th>
                            <th scope="col" class="text-end">Net Sales (ex tax)</th>
                            <th scope="col" class="text-end">Tax Total</th>
                            <th scope="col" class="text-end">Gross Sales (incl. tax)</th>
                            <th scope="col" class="text-end">Discounts (incl. tax)</th>
                            <th scope="col" class="text-end">Net Sales After Discounts (ex tax)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-secondary">
                            <th scope="row" colspan="10" class="text-uppercase">PRIVATE SUITES</th>
                        </tr>
                        <tr>
                            <td>799</td>
                            <td>17oz Draft Beer - Pilsner BWK</td>
                            <td class="text-end">9.441765</td>
                            <td class="text-end">1.010588</td>
                            <td class="text-end">17</td>
                            <td class="text-end">143.33</td>
                            <td class="text-end">17.18</td>
                            <td class="text-end">160.51</td>
                            <td class="text-end">-24.51</td>
                            <td class="text-end">118.82</td>
                        </tr>
                        <tr>
                            <td>1169</td>
                            <td>473ml Farmery Light</td>
                            <td class="text-end">9.73</td>
                            <td class="text-end">1.04</td>
                            <td class="text-end">6</td>
                            <td class="text-end">52.14</td>
                            <td class="text-end">6.24</td>
                            <td class="text-end">58.38</td>
                            <td class="text-end">-8.88</td>
                            <td class="text-end">43.26</td>
                        </tr>
                        <tr>
                            <td>353</td>
                            <td>Can - Blue Moon</td>
                            <td class="text-end">10.62</td>
                            <td class="text-end">1.136667</td>
                            <td class="text-end">3</td>
                            <td class="text-end">28.45</td>
                            <td class="text-end">3.41</td>
                            <td class="text-end">31.86</td>
                            <td class="text-end">-4.86</td>
                            <td class="text-end">23.59</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="mb-0 text-muted">Totals rows and the trailing cost/margin columns that IdealPOS adds after the net sales figures can remain in the spreadsheetâ€”the importer ignores them.</p>
        </div>
    </div>
{% endif %}
{% if mapping_payload %}
<script src="{{ url_for('static', filename='js/terminal_sales_summary_toggle.js') }}" defer></script>
{% endif %}
{% if mapping_payload and product_resolution_required and active_stage == 'products' %}
<script src="{{ url_for('static', filename='js/terminal_sales_mapping.js') }}" defer></script>
{% endif %}
{% endblock %}
