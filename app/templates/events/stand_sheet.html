{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="mb-3">
            <div>Location: {{ location.name }}</div>
            <div>Event: {{ event.name }}</div>
            <div>Event Date/Time: {{ event.start_date }}</div>
        </div>
    <div class="table-responsive">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Item (Report Unit)</th>
                <th>Prior Event Close</th>
                <th>Pre-Event Count</th>
                <th>Transferred In</th>
                <th>Transferred Out</th>
                <th>Sales</th>
                <th>Eaten</th>
                <th>Spoiled</th>
                <th>Closing Count</th>
                <th>Variance</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in stand_items %}
            {% set opening_val = entry.sheet_values.opening_count or 0 %}
            {% set in_val = entry.sheet_values.transferred_in or 0 %}
            {% set out_val = entry.sheet_values.transferred_out or 0 %}
            {% set eaten_val = entry.sheet_values.eaten or 0 %}
            {% set spoiled_val = entry.sheet_values.spoiled or 0 %}
            {% set close_val = entry.sheet_values.closing_count or 0 %}
            {% set variance = opening_val + in_val - out_val - entry.sales - eaten_val - spoiled_val - close_val %}
            <tr>
                <td>
                    {{ entry.item.name }}
                    {% if entry.report_unit_label %}
                        ({{ entry.report_unit_label }})
                    {% endif %}
                </td>
                <td>
                    {% if entry.expected is not none %}
                        {{ '%.2f'|format(entry.expected) }}
                    {% endif %}
                </td>
                <td>
                    <input type="number" step="any" class="form-control" name="open_{{ entry.item.id }}" value="{% if entry.sheet_values.opening_count is not none %}{{ '%.4f'|format(entry.sheet_values.opening_count) }}{% endif %}">
                </td>
                <td>
                    <input type="number" step="any" class="form-control" name="in_{{ entry.item.id }}" value="{% if entry.sheet_values.transferred_in is not none %}{{ '%.4f'|format(entry.sheet_values.transferred_in) }}{% endif %}">
                </td>
                <td>
                    <input type="number" step="any" class="form-control" name="out_{{ entry.item.id }}" value="{% if entry.sheet_values.transferred_out is not none %}{{ '%.4f'|format(entry.sheet_values.transferred_out) }}{% endif %}">
                </td>
                <td class="sales" data-sales="{{ '%.4f'|format(entry.sales) }}">{{ '%.2f'|format(entry.sales) }}</td>
                <td>
                    <input type="number" step="any" class="form-control" name="eaten_{{ entry.item.id }}" value="{% if entry.sheet_values.eaten is not none %}{{ '%.4f'|format(entry.sheet_values.eaten) }}{% endif %}">
                </td>
                <td>
                    <input type="number" step="any" class="form-control" name="spoiled_{{ entry.item.id }}" value="{% if entry.sheet_values.spoiled is not none %}{{ '%.4f'|format(entry.sheet_values.spoiled) }}{% endif %}">
                </td>
                <td>
                    <input type="number" step="any" class="form-control" name="close_{{ entry.item.id }}" value="{% if entry.sheet_values.closing_count is not none %}{{ '%.4f'|format(entry.sheet_values.closing_count) }}{% endif %}">
                </td>
                <td class="variance">{% if entry.sheet %}{{ '%.2f'|format(variance) }}{% else %}0.00{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
    </form>
</div>
<script nonce="{{ csp_nonce }}">
    function calcVariance(row) {
        const sales = parseFloat(row.querySelector('.sales').dataset.sales) || 0;
        const pre = parseFloat(row.querySelector('input[name^="open_"]').value) || 0;
        const tin = parseFloat(row.querySelector('input[name^="in_"]').value) || 0;
        const tout = parseFloat(row.querySelector('input[name^="out_"]').value) || 0;
        const eaten = parseFloat(row.querySelector('input[name^="eaten_"]').value) || 0;
        const spoiled = parseFloat(row.querySelector('input[name^="spoiled_"]').value) || 0;
        const close = parseFloat(row.querySelector('input[name^="close_"]').value) || 0;
        const variance = pre + tin - tout - sales - eaten - spoiled - close;
        row.querySelector('.variance').textContent = variance.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('tbody tr').forEach(function(row){
            row.querySelectorAll('input').forEach(function(inp){
                inp.addEventListener('input', function(){ calcVariance(row); });
            });
            calcVariance(row);
        });
    });
</script>
{% endblock %}
