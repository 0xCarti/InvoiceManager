{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h1 class="h3 mb-1">{{ event.name }} — Closed Event Report</h1>
            <p class="mb-0 text-muted">{{ event.start_date }} – {{ event.end_date }}</p>
            {% if event.estimated_sales is not none %}
                <p class="mb-0 text-muted">Estimated Sales: ${{ '{:,.2f}'.format(event.estimated_sales) }}</p>
            {% endif %}
        </div>
        <div class="text-md-end">
            <a class="btn btn-secondary" href="{{ url_for('event.view_event', event_id=event.id) }}">Back to Event</a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">Terminal Sales Summary</div>
                <div class="card-body">
                    <p class="mb-1"><strong>Total Quantity:</strong> {{ '%.2f'|format(totals.terminal_quantity) }}</p>
                    <p class="mb-0"><strong>Total Amount:</strong> ${{ '%.2f'|format(totals.terminal_amount) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">Physical Sales Summary</div>
                <div class="card-body">
                    <p class="mb-1"><strong>Total Quantity:</strong> {{ '%.2f'|format(totals.physical_quantity) }}</p>
                    <p class="mb-0"><strong>Total Amount:</strong>
                        {% if totals.physical_amount is not none %}
                            ${{ '%.2f'|format(totals.physical_amount) }}
                        {% else %}
                            <span class="text-muted">Not available</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    {% if not has_stand_data %}
        <div class="alert alert-info" role="alert">
            No stand sheet data was recorded for this event.
        </div>
    {% endif %}

    {% for report in locations %}
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2">
                    <div>
                        <h2 class="h5 mb-1">{{ report.location.name if report.location else 'Unknown Location' }}</h2>
                        <p class="mb-0 text-muted">
                            Terminal Sales: {{ '%.2f'|format(report.terminal.quantity) }} units — ${{ '%.2f'|format(report.terminal.amount) }}
                        </p>
                        <p class="mb-0 text-muted">
                            Physical Sales: {{ '%.2f'|format(report.physical.quantity) }} units —
                            {% if report.physical.amount is not none %}
                                ${{ '%.2f'|format(report.physical.amount) }}
                            {% else %}
                                <span class="text-muted">Not available</span>
                            {% endif %}
                        </p>
                    </div>
                    {% if report.notes %}
                        <span class="badge bg-secondary">Notes Recorded</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                {% if report.stand_items %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">Item</th>
                                    <th scope="col">Prior Close</th>
                                    <th scope="col">Pre-Event Count</th>
                                    <th scope="col">Transferred In</th>
                                    <th scope="col">Transferred Out</th>
                                    <th scope="col">Adjustments</th>
                                    <th scope="col">Terminal Sales</th>
                                    <th scope="col">Eaten</th>
                                    <th scope="col">Spoiled</th>
                                    <th scope="col">Closing Count</th>
                                    <th scope="col">Physical Sales</th>
                                    <th scope="col">Physical Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in report.stand_items %}
                                    <tr>
                                        <td>
                                            {% if entry.item %}
                                                {{ entry.item.name }}
                                            {% else %}
                                                <span class="text-muted">Unknown Item</span>
                                            {% endif %}
                                            {% if entry.report_unit_label %}
                                                <div class="text-muted small">{{ entry.report_unit_label }}</div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.expected is not none %}
                                                {{ '%.2f'|format(entry.expected) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.sheet_values.opening_count is not none %}
                                                {{ '%.2f'|format(entry.sheet_values.opening_count) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.sheet_values.transferred_in is not none %}
                                                {{ '%.2f'|format(entry.sheet_values.transferred_in) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.sheet_values.transferred_out is not none %}
                                                {{ '%.2f'|format(entry.sheet_values.transferred_out) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.sheet_values.adjustments is not none %}
                                                {{ '%.2f'|format(entry.sheet_values.adjustments) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ '%.2f'|format(entry.sales) }}</td>
                                        <td>
                                            {% if entry.sheet_values.eaten is not none %}
                                                {{ '%.2f'|format(entry.sheet_values.eaten) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.sheet_values.spoiled is not none %}
                                                {{ '%.2f'|format(entry.sheet_values.spoiled) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.sheet_values.closing_count is not none %}
                                                {{ '%.2f'|format(entry.sheet_values.closing_count) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.physical_units_display is not none %}
                                                {{ '%.2f'|format(entry.physical_units_display) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if entry.physical_amount is not none %}
                                                ${{ '%.2f'|format(entry.physical_amount) }}
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if not report.has_sheet_data %}
                        <p class="mb-0 p-3 text-muted border-top">No stand sheet data was submitted for this location.</p>
                    {% endif %}
                {% else %}
                    <p class="mb-0 p-3 text-muted">No stand sheet items are configured for this location.</p>
                {% endif %}

                {% if report.notes %}
                    <div class="p-3 border-top">
                        <h3 class="h6 mb-1">Stand Notes</h3>
                        <p class="mb-0" style="white-space: pre-wrap;">{{ report.notes }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
</div>
{% endblock %}
