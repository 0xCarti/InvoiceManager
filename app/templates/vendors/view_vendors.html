<!-- templates=view_vendors.html -->
{% extends "base.html" %}

{% block title %}View Vendors{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Vendors</h2>
    <button type="button" class="btn btn-primary mb-3" id="createVendorBtn">Create Vendor</button>
    <div class="table-responsive">
    <table class="table" id="vendorTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>GST Exempt</th>
                <th>PST Exempt</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for vendor in vendors.items %}
            {% include 'vendors/_vendor_row.html' with context %}
            {% endfor %}
        </tbody>
    </table>
    </div>
    <nav aria-label="Vendor pagination">
        <ul class="pagination">
            {% if vendors.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('vendor.view_vendors', page=vendors.prev_num) }}">Previous</a>
            </li>
            {% endif %}
            <li class="page-item disabled">
                <span class="page-link">Page {{ vendors.page }} of {{ vendors.pages }}</span>
            </li>
            {% if vendors.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('vendor.view_vendors', page=vendors.next_num) }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- Vendor Modal -->
<div class="modal fade" id="vendorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Vendor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>

<script>
const modalEl = document.getElementById('vendorModal');

function bindVendorForm() {
    const form = modalEl.querySelector('form');
    if (!form) return;
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch('{{ url_for('vendor.create_vendor') }}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrf_token')
            },
            body: formData
        }).then(r => r.json()).then(data => {
            if (data.success) {
                document.querySelector('#vendorTable tbody').insertAdjacentHTML('beforeend', data.row_html);
                bootstrap.Modal.getInstance(modalEl).hide();
            } else if (data.form_html) {
                modalEl.querySelector('.modal-body').innerHTML = data.form_html;
                bindVendorForm();
            }
        });
    });
}

document.getElementById('createVendorBtn').addEventListener('click', function() {
    fetch('{{ url_for('vendor.create_vendor') }}', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(r => r.text()).then(html => {
        modalEl.querySelector('.modal-body').innerHTML = html;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        bindVendorForm();
    });
});
</script>
{% endblock %}
