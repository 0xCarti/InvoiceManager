{% extends 'base.html' %}
{% from 'macros/filter_modal.html' import filter_modal %}

{% block content %}
<div class="container mt-5">
    <h2>Items List</h2>
    <div class="row justify-content-between">
        <div class="col-auto d-flex flex-wrap gap-2">
            <a href="{{ url_for('item.add_item') }}" class="btn btn-primary mb-3" id="createItemBtn">Add New Item</a>
            <a href="{{ url_for('item.recipe_cost_calculator') }}" class="btn btn-outline-primary mb-3" id="recipeCostCalculatorBtn">Recipe Cost Calculator</a>
            <a href="{{ url_for('report.purchase_cost_forecast') }}" class="btn btn-outline-primary mb-3" id="forecastedStockItemSalesBtn">Forecasted Stock Item Sales</a>
        </div>
        <div class="col-auto">
            <div class="dropdown d-inline-block mb-3 me-2" data-column-visibility data-table-id="itemsTable" data-storage-key="itemsTableColumnVisibility">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="columnSelectorDropdown"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    Columns
                </button>
                <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="columnSelectorDropdown">
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-id"
                            data-column-target="col-id" checked>
                        <label class="form-check-label" for="toggle-column-id">ID</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-name"
                            data-column-target="col-name" checked>
                        <label class="form-check-label" for="toggle-column-name">Name</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-base-unit"
                            data-column-target="col-base-unit" checked>
                        <label class="form-check-label" for="toggle-column-base-unit">Base Unit</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-cost"
                            data-column-target="col-cost" checked>
                        <label class="form-check-label" for="toggle-column-cost">Cost / Base Unit</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-quantity"
                            data-column-target="col-quantity" checked>
                        <label class="form-check-label" for="toggle-column-quantity">Quantity</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-gl-code"
                            data-column-target="col-gl-code" checked>
                        <label class="form-check-label" for="toggle-column-gl-code">Inventory GL Code</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-gl-desc"
                            data-column-target="col-gl-desc" checked>
                        <label class="form-check-label" for="toggle-column-gl-desc">Inventory GL Description</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-purchase-gl-code"
                            data-column-target="col-purchase-gl-code" checked>
                        <label class="form-check-label" for="toggle-column-purchase-gl-code">Purchase GL Code</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-purchase-gl-desc"
                            data-column-target="col-purchase-gl-desc" checked>
                        <label class="form-check-label" for="toggle-column-purchase-gl-desc">Purchase GL Description</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-units"
                            data-column-target="col-units" checked>
                        <label class="form-check-label" for="toggle-column-units">Units</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-receiving-default"
                            data-column-target="col-receiving-default" checked>
                        <label class="form-check-label" for="toggle-column-receiving-default">Receiving Default Unit</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-transfer-default"
                            data-column-target="col-transfer-default" checked>
                        <label class="form-check-label" for="toggle-column-transfer-default">Transfer Default Unit</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input column-toggle" type="checkbox" id="toggle-column-archived"
                            data-column-target="col-archived" checked>
                        <label class="form-check-label" for="toggle-column-archived">Archived</label>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary mb-3" data-bs-toggle="modal" data-bs-target="#filterModal">
                Filters
            </button>
            <a href="{{ url_for('item.import_items') }}" class="btn btn-info mb-3">Import Items</a>
            <button type="submit" form="bulk-delete-form" class="btn btn-warning mb-3" data-confirm-message="Are you sure?">Delete Items</button>
        </div>
    </div>

    <!-- Filter Modal -->
    {% call filter_modal(
        'filterModal',
        'Filters',
        form_id='filter-form',
        form_action=url_for('item.view_items'),
        method='get',
        reset_url=url_for('item.view_items', reset=1),
        dialog_class='modal-lg'
    ) %}
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label for="name_query" class="form-label">Name</label>
                <input type="text" id="name_query" name="name_query" class="form-control" placeholder="Search name" value="{{ name_query or '' }}">
            </div>
            <div class="col-md-6">
                <label for="match_mode" class="form-label">Match Mode</label>
                <select id="match_mode" name="match_mode" class="form-select">
                    <option value="exact" {% if match_mode == 'exact' %}selected{% endif %}>Exact</option>
                    <option value="startswith" {% if match_mode == 'startswith' %}selected{% endif %}>Starts with</option>
                    <option value="contains" {% if match_mode == 'contains' %}selected{% endif %}>Contains</option>
                    <option value="not_contains" {% if match_mode == 'not_contains' %}selected{% endif %}>Does not contain</option>
                </select>
            </div>
        </div>
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label for="purchase_gl_code_id" class="form-label">Purchase GL Code</label>
                <select id="purchase_gl_code_id" name="purchase_gl_code_id" class="form-select" multiple>
                    <option value="" {% if not purchase_gl_code_ids %}selected{% endif %}>All Purchase GL Codes</option>
                    {% for gl in purchase_gl_codes %}
                    <option value="{{ gl.id }}" {% if gl.id in purchase_gl_code_ids %}selected{% endif %}>{{ gl.code }} - {{ gl.description }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="vendor_id" class="form-label">Vendor</label>
                <select id="vendor_id" name="vendor_id" class="form-select" multiple>
                    <option value="" {% if not vendor_ids %}selected{% endif %}>All Vendors</option>
                    {% for v in vendors %}
                    <option value="{{ v.id }}" {% if v.id in vendor_ids %}selected{% endif %}>{{ v.first_name }} {{ v.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label for="archived" class="form-label">Status</label>
                <select id="archived" name="archived" class="form-select">
                    <option value="active" {% if archived == 'active' %}selected{% endif %}>Active</option>
                    <option value="archived" {% if archived == 'archived' %}selected{% endif %}>Archived</option>
                    <option value="all" {% if archived == 'all' %}selected{% endif %}>All</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="base_unit" class="form-label">Base Unit</label>
                <select id="base_unit" name="base_unit" class="form-select">
                    <option value="">All Base Units</option>
                    {% for unit in base_units %}
                    <option value="{{ unit }}" {% if base_unit == unit %}selected{% endif %}>{{ unit|capitalize }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label for="cost_min" class="form-label">Cost ≥</label>
                <input type="number" step="0.01" id="cost_min" name="cost_min" class="form-control" value="{{ cost_min if cost_min is not none else '' }}">
            </div>
            <div class="col-md-6">
                <label for="cost_max" class="form-label">Cost ≤</label>
                <input type="number" step="0.01" id="cost_max" name="cost_max" class="form-control" value="{{ cost_max if cost_max is not none else '' }}">
            </div>
        </div>
    {% endcall %}
    {% if active_purchase_gl_codes %}
    <div class="mb-3">
        <strong>Filtering by Purchase GL Code:</strong> {{ active_purchase_gl_codes | map(attribute='code') | join(', ') }}
    </div>
    {% endif %}
    {% if base_unit %}
    <div class="mb-3">
        <strong>Filtering by Base Unit:</strong> {{ base_unit|capitalize }}
    </div>
    {% endif %}
    {% if active_vendors %}
    <div class="mb-3">
        <strong>Filtering by Vendor:</strong>
        {% for v in active_vendors %}
            {{ v.first_name }} {{ v.last_name }}{% if not loop.last %}, {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    <form id="bulk-delete-form" action="{{ url_for('item.bulk_delete_items') }}" method="post">
        {{ bulk_delete_form.hidden_tag() }}
        <div class="table-responsive">
        <table class="table sortable" id="itemsTable">
            <thead>
                <tr>
                    <th scope="col" class="col-select"><input type="checkbox" id="select-all" style="transform: scale(1.5);"></th>
                    <th scope="col" class="col-id" data-type="number">ID</th>
                    <th scope="col" class="col-name">Name</th>
                    <th scope="col" class="col-base-unit">Base Unit</th>
                    <th scope="col" class="col-cost" data-type="number">Cost / Base Unit</th>
                    <th scope="col" class="col-quantity" data-type="number">Quantity</th>
                    <th scope="col" class="col-gl-code">Inventory GL Code</th>
                    <th scope="col" class="col-gl-desc">Inventory GL Description</th>
                    <th scope="col" class="col-purchase-gl-code">Purchase GL Code</th>
                    <th scope="col" class="col-purchase-gl-desc">Purchase GL Description</th>
                    <th scope="col" class="col-units">Units</th>
                    <th scope="col" class="col-receiving-default">Receiving Default Unit</th>
                    <th scope="col" class="col-transfer-default">Transfer Default Unit</th>
                    <th scope="col" class="col-archived">Archived</th>
                    <th scope="col" class="col-actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items.items %}
                {% include 'items/_item_row.html' %}
                {% endfor %}
            </tbody>
        </table>
        </div>
    </form>
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mt-3">
        <nav aria-label="Item pagination">
            <ul class="pagination mb-0">
                <li class="page-item {% if not items.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('item.view_items', page=items.prev_num if items.has_prev else 1, **pagination_args) }}"{% if not items.has_prev %} tabindex="-1" aria-disabled="true"{% endif %}>Previous</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Page {{ items.page }} of {{ items.pages }}</span>
                </li>
                <li class="page-item {% if not items.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('item.view_items', page=items.next_num if items.has_next else items.pages or 1, **pagination_args) }}"{% if not items.has_next %} tabindex="-1" aria-disabled="true"{% endif %}>Next</a>
                </li>
            </ul>
        </nav>
        <form method="get" class="d-flex align-items-center gap-2">
            {% for key, values in request.args.lists() %}
                {% if key not in ['page', 'per_page'] %}
                    {% for value in values %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endfor %}
                {% endif %}
            {% endfor %}
            <input type="hidden" name="page" value="1">
            <label for="items-per-page" class="form-label mb-0">Rows per page</label>
            <select id="items-per-page" name="per_page" class="form-select js-auto-submit">
                {% for option in PAGINATION_SIZES %}
                    <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>
<script src="{{ url_for('static', filename='js/item_form.js') }}"></script>
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    var selectAll = document.getElementById('select-all');
    if (selectAll) {
        selectAll.addEventListener('click', function() {
            var checkboxes = document.querySelectorAll('input[type="checkbox"][name="item_ids"]');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = selectAll.checked;
            });
        });
    }
});
</script>
<!-- Item Modal -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% with form=create_form, item=None %}
                    {% include 'items/item_form.html' %}
                {% endwith %}
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
const itemModalEl = document.getElementById('itemModal');
const itemModalBody = itemModalEl ? itemModalEl.querySelector('.modal-body') : null;
const scriptNonce = {{ csp_nonce | tojson }};
let createItemTemplate = '';

if (itemModalBody) {
    createItemTemplate = itemModalBody.innerHTML.trim();
    itemModalBody.innerHTML = '';
}

function updateModalBody(html) {
    if (!itemModalBody) {
        return;
    }

    const template = document.createElement('template');
    template.innerHTML = html || '';
    const fragment = template.content;

    const scripts = fragment.querySelectorAll('script');
    scripts.forEach((originalScript) => {
        const newScript = document.createElement('script');
        Array.from(originalScript.attributes).forEach((attr) => {
            if (attr.name.toLowerCase() === 'nonce') {
                return;
            }
            newScript.setAttribute(attr.name, attr.value);
        });

        if (originalScript.src) {
            const srcValue = originalScript.src;
            const alreadyLoaded = Array.from(document.querySelectorAll('script[src]'))
                .some((scriptEl) => scriptEl.src === srcValue);
            if (!alreadyLoaded) {
                if (scriptNonce) {
                    newScript.setAttribute('nonce', scriptNonce);
                }
                newScript.src = srcValue;
                document.head.appendChild(newScript);
            }
            originalScript.remove();
            return;
        }

        newScript.textContent = originalScript.textContent;
        if (scriptNonce) {
            newScript.setAttribute('nonce', scriptNonce);
        }
        originalScript.replaceWith(newScript);
    });

    itemModalBody.innerHTML = '';
    itemModalBody.appendChild(fragment);
}

function initializeItemForm() {
    if (window.ItemForm && typeof window.ItemForm.init === 'function') {
        window.ItemForm.init(itemModalEl);
    }
}

function bindItemForm(actionUrl) {
    const form = itemModalEl.querySelector('form');
    if (!form) return;
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        fetch(actionUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrf_token')
            },
            body: formData
        }).then(r => r.json()).then(data => {
            if (data.success) {
                if (data.row_html) {
                    if (data.item_id && document.getElementById('item-row-' + data.item_id)) {
                        document.getElementById('item-row-' + data.item_id).outerHTML = data.row_html;
                    } else {
                        document.querySelector('#itemsTable tbody').insertAdjacentHTML('beforeend', data.row_html);
                    }
                }
                bootstrap.Modal.getInstance(itemModalEl).hide();
            } else if (data.form_html) {
                updateModalBody(data.form_html);
                initializeItemForm();
                bindItemForm(actionUrl);
            }
        });
    });
}

const createItemBtn = document.getElementById('createItemBtn');
if (createItemBtn) {
    createItemBtn.addEventListener('click', function(event) {
        if (event.defaultPrevented || event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) {
            return;
        }
        event.preventDefault();
        if (!createItemTemplate) {
            return;
        }
        itemModalEl.dataset.mode = 'create';
        itemModalEl.querySelector('.modal-title').textContent = 'Add Item';
        updateModalBody(createItemTemplate);
        initializeItemForm();
        const modal = bootstrap.Modal.getOrCreateInstance(itemModalEl);
        modal.show();
        bindItemForm('{{ url_for('item.add_item') }}');
    });
}

const itemsTableEl = document.querySelector('#itemsTable');
if (itemsTableEl) {
    itemsTableEl.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-item-btn')) {
            const itemId = e.target.getAttribute('data-item-id');
            const url = '{{ url_for('item.edit_item', item_id=0) }}'.replace('0', itemId);
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.text())
                .then(html => {
                    itemModalEl.dataset.mode = 'edit';
                    itemModalEl.querySelector('.modal-title').textContent = 'Edit Item';
                    updateModalBody(html);
                    initializeItemForm();
                    const modal = bootstrap.Modal.getOrCreateInstance(itemModalEl);
                    modal.show();
                    bindItemForm(url);
                });
        } else if (e.target.classList.contains('copy-item-btn')) {
            const itemId = e.target.getAttribute('data-item-id');
            const url = '{{ url_for('item.copy_item', item_id=0) }}'.replace('0', itemId);
            const actionUrl = '{{ url_for('item.add_item') }}';
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.text())
                .then(html => {
                    itemModalEl.dataset.mode = 'copy';
                    itemModalEl.querySelector('.modal-title').textContent = 'Copy Item';
                    updateModalBody(html);
                    initializeItemForm();
                    const modal = bootstrap.Modal.getOrCreateInstance(itemModalEl);
                    modal.show();
                    bindItemForm(actionUrl);
                });
        }
    });
}

if (itemModalEl) {
    itemModalEl.addEventListener('hidden.bs.modal', () => {
        if (itemModalEl.dataset.mode === 'create') {
            itemModalBody.innerHTML = '';
        }
        itemModalEl.dataset.mode = '';
    });
}
</script>
{% endblock %}
