<!-- templates/view_invoices.html -->

{% extends "base.html" %}
{% from "macros/column_visibility.html" import column_visibility_dropdown %}
{% from 'macros/filter_modal.html' import filter_modal %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Invoices</h2>
    <div class="row mb-3 align-items-start justify-content-between">
        <div class="col">
            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">Create Invoice</button>
            <button type="button" class="btn btn-secondary mb-3" data-bs-toggle="modal" data-bs-target="#filterModal">Filter</button>
            <a href="{{ url_for('report.vendor_invoice_report') }}" class="btn btn-secondary mb-3">Vendor Report</a>
            <a href="{{ url_for('report.purchase_inventory_summary') }}" class="btn btn-secondary mb-3">Purchase Inventory Summary</a>
            <a href="{{ url_for('report.product_sales_report') }}" class="btn btn-secondary mb-3">Revenue Report</a>
            <a href="{{ url_for('report.product_stock_usage_report') }}" class="btn btn-secondary mb-3">Stock Usage Report</a>
            <a href="{{ url_for('report.department_sales_forecast') }}" class="btn btn-secondary mb-3">Department Sales Forecast</a>
        </div>
        <div class="col-auto text-end">
            {{ column_visibility_dropdown(
                table_id='invoiceTable',
                storage_key='invoiceTableColumnVisibility',
                columns=[
                    {'id': 'toggle-invoice-number', 'target': 'col-invoice-number', 'label': 'Invoice Number', 'checked': True},
                    {'id': 'toggle-invoice-date', 'target': 'col-invoice-date', 'label': 'Date', 'checked': True},
                    {'id': 'toggle-invoice-customer', 'target': 'col-invoice-customer', 'label': 'Customer Name', 'checked': True},
                    {'id': 'toggle-invoice-actions', 'target': 'col-invoice-actions', 'label': 'Actions', 'checked': True},
                ]
            ) }}
        </div>
    </div>

    <div class="table-responsive">
    <table class="table sortable" id="invoiceTable">
        <thead>
            <tr>
                <th scope="col" class="col-invoice-number" data-type="number">Invoice Number</th>
                <th scope="col" class="col-invoice-date">Date</th>
                <th scope="col" class="col-invoice-customer">Customer Name</th>
                <th scope="col" class="col-invoice-actions" data-sortable="false">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in invoices.items %}
            <tr>
                <td class="col-invoice-number">{{ invoice.id }}</td>
                <td class="col-invoice-date">{{ invoice.date_created|format_datetime('%Y-%m-%d') }}</td>
                <td class="col-invoice-customer">{{ invoice.customer.first_name }} {{ invoice.customer.last_name }}</td>
                <td class="col-invoice-actions">
                    <a href="{{ url_for('invoice.view_invoice', invoice_id=invoice.id) }}" class="btn btn-primary mr-2">View</a>
                    <form action="{{ url_for('invoice.delete_invoice', invoice_id=invoice.id) }}" method="post" class="d-inline">
                        {{ delete_form.hidden_tag() }}
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mt-3">
        <nav aria-label="Invoice pagination">
            <ul class="pagination mb-0">
                <li class="page-item {% if not invoices.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('invoice.view_invoices', page=invoices.prev_num if invoices.has_prev else 1, **pagination_args) }}"{% if not invoices.has_prev %} tabindex="-1" aria-disabled="true"{% endif %}>Previous</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Page {{ invoices.page }} of {{ invoices.pages }}</span>
                </li>
                <li class="page-item {% if not invoices.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('invoice.view_invoices', page=invoices.next_num if invoices.has_next else invoices.pages or 1, **pagination_args) }}"{% if not invoices.has_next %} tabindex="-1" aria-disabled="true"{% endif %}>Next</a>
                </li>
            </ul>
        </nav>
        <form method="get" class="d-flex align-items-center gap-2">
            {% for key, values in request.args.lists() %}
                {% if key not in ['page', 'per_page'] %}
                    {% for value in values %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endfor %}
                {% endif %}
            {% endfor %}
            <input type="hidden" name="page" value="1">
            <label for="invoices-per-page" class="form-label mb-0">Rows per page</label>
            <select id="invoices-per-page" name="per_page" class="form-select js-auto-submit">
                {% for option in PAGINATION_SIZES %}
                    <option value="{{ option }}" {% if per_page == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
            </select>
        </form>
    </div>
</div>

<!-- Filter Modal -->
{% call filter_modal(
    'filterModal',
    'Filter Invoices',
    form_id='filterForm',
    form_action=url_for('invoice.filter_invoices_api'),
    method='get',
    reset_url=url_for('invoice.view_invoices'),
    ajax=True
) %}
    {{ form.hidden_tag() }}
    <div class="mb-3">
        {{ form.invoice_id.label }} {{ form.invoice_id(class="form-control") }}
    </div>
    <div class="mb-3">
        {{ form.customer_id.label }} {{ form.customer_id(class="form-control") }}
    </div>
    <div class="mb-3">
        {{ form.start_date.label }} {{ form.start_date(class="form-control") }}
    </div>
    <div class="mb-3">
        {{ form.end_date.label }} {{ form.end_date(class="form-control") }}
    </div>
{% endcall %}

<!-- Create Invoice Modal -->
<div class="modal fade" id="createInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Invoice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% with form=create_form %}
          {% include "invoices/_invoice_form.html" %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>

<script nonce="{{ csp_nonce }}">
$(document).ready(function(){
    const deleteFormHTML = {{ delete_form.hidden_tag()|tojson }};

    function renderInvoices(invoices){
        const tbody = $('#invoiceTable tbody');
        tbody.empty();
        invoices.forEach(function(inv){
        const row = `<tr>
            <td class="col-invoice-number">${inv.id}</td>
            <td class="col-invoice-date">${inv.date}</td>
            <td class="col-invoice-customer">${inv.customer}</td>
            <td class="col-invoice-actions">
                <a href="/view_invoice/${inv.id}" class="btn btn-primary mr-2">View</a>
                <form action="/delete_invoice/${inv.id}" method="post" class="d-inline">
                    ${deleteFormHTML}
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>`;
            tbody.append(row);
        });
        if (window.TableSort && typeof window.TableSort.bind === 'function') {
            window.TableSort.bind(document.getElementById('invoiceTable'));
        }
    }

    let currentFilters = '';

    const filterModalEl = document.querySelector('[data-filter-modal]');
    const filterFormEl = filterModalEl ? filterModalEl.querySelector('[data-filter-form]') : null;
    const filterFormAction = filterFormEl ? (filterFormEl.getAttribute('action') || '{{ url_for('invoice.filter_invoices_api') }}') : '{{ url_for('invoice.filter_invoices_api') }}';

    function loadInvoices(){
        $.getJSON(filterFormAction, currentFilters, function(data){
            renderInvoices(data.invoices);
        });
    }

    if (filterFormEl) {
        const $filterForm = $(filterFormEl);
        $filterForm.on('submit', function(e){
            e.preventDefault();
            currentFilters = $filterForm.serialize();
            loadInvoices();
            if (filterModalEl) {
                const modal = bootstrap.Modal.getInstance(filterModalEl);
                if (modal) { modal.hide(); }
            }
        });
    }

    // Create invoice form logic
    let currentTaxStatus = { gst_exempt: false, pst_exempt: false };
    const initialCustomerId = $('#customerSelect').val();
    if (initialCustomerId) {
        $.get(`/get_customer_tax_status/${initialCustomerId}`, function (data) {
            currentTaxStatus = data;
        });
    }
    $('#customerSelect').on('change', function () {
        const customerId = $(this).val();
        if (customerId) {
            $.get(`/get_customer_tax_status/${customerId}`, function (data) {
                currentTaxStatus = data;
            });
        }
    });

    $('#productSearch').keyup(function () {
        var query = $(this).val();
        $.ajax({
            url: '/search_products',
            data: { query: query },
            success: function (response) {
                var suggestions = response.map(function (product) {
                    return '<a href="#" class="list-group-item list-group-item-action" data-name="' + product.name + '" data-price="' + product.price + '">' + product.name + ' - $' + product.price + '</a>';
                });
                $('#productSuggestions').html(suggestions.join(''));
            }
        });
    });

    $('#productSuggestions').on('click', '.list-group-item', function (e) {
        e.preventDefault();
        var productName = $(this).data('name');
        var productPrice = $(this).data('price');

        var newRow = `<tr class="product-row">
    <td>${productName}</td>
    <td><input type="text" class="form-control quantity" value="1" inputmode="decimal" data-numeric-input="1"></td>
    <td class="price">$${productPrice}</td>
    <td class="total">$${(parseFloat(productPrice)).toFixed(2)}</td>
    <td>
        <label><input type="checkbox" class="override-gst"${!currentTaxStatus.gst_exempt ? ' checked' : ''}> GST</label><br>
        <label><input type="checkbox" class="override-pst"${!currentTaxStatus.pst_exempt ? ' checked' : ''}> PST</label>
    </td>
    <td><button type="button" class="btn btn-danger btn-sm">Remove</button></td>
</tr>`;
        $('#productTable tbody').append(newRow);

        const row = $('#productTable tbody tr').last();
        if (window.NumericInput) {
            window.NumericInput.enableWithin(row.get(0));
        }
        updateRowTotal(row);
    });

    $('#productTable').on('input', '.quantity', function () {
        const row = $(this).closest('tr');
        updateRowTotal(row);
    });

    $('#productTable').on('change', '.override-gst, .override-pst', function () {
        const row = $(this).closest('tr');
        updateRowTotal(row);
    });

    $('#productTable').on('click', '.btn-danger', function () {
        $(this).closest('tr').remove();
    });

    function parseNumber(value, defaultValue = 0) {
        if (window.NumericInput) {
            const parsed = window.NumericInput.parseValue(value);
            return Number.isFinite(parsed) ? parsed : defaultValue;
        }
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : defaultValue;
    }

    function updateRowTotal(row) {
        const quantity = parseNumber(row.find('.quantity').val(), 0);
        const price = parseNumber(row.find('.price').text().replace('$', ''), 0);
        const applyGST = row.find('.override-gst').is(':checked');
        const applyPST = row.find('.override-pst').is(':checked');

        const subtotal = quantity * price;
        const gst = applyGST ? subtotal * 0.05 : 0;
        const pst = applyPST ? subtotal * 0.07 : 0;
        const total = subtotal + gst + pst;

        row.find('.total').text(`$${total.toFixed(2)}`);
    }

    $('#invoiceForm').on('submit', function (e) {
        e.preventDefault();
        let products = '';
        $('#productTable tbody tr').each(function () {
            const productName = $(this).find('td:first-child').text();
            const quantity = $(this).find('.quantity').val();
            const override_gst = $(this).find('.override-gst').is(':checked') ? 1 : 0;
            const override_pst = $(this).find('.override-pst').is(':checked') ? 1 : 0;
            products += `${productName}?${quantity}?${override_gst}?${override_pst}:`;
        });
        $('#products').val(products);
        $.post("{{ url_for('invoice.create_invoice_api') }}", $(this).serialize(), function () {
            $('#createInvoiceModal').modal('hide');
            $('#invoiceForm')[0].reset();
            $('#productTable tbody').empty();
            loadInvoices();
        });
    });
});
</script>
{% endblock %}
