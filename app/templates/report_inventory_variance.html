{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <h2 class="mb-0">Inventory Variance Report</h2>
        <a class="btn btn-outline-secondary" href="{{ url_for('purchase.view_purchase_invoices') }}">Back to Purchase Invoices</a>
    </div>
    <p class="text-muted">Compare received purchase quantities against product recipe usage to highlight potential overstocking or shortages. Narrow the report by item or purchase GL code as needed.</p>

    <form method="POST" class="mb-4">
        {{ form.hidden_tag() }}
        <div class="row g-3">
            <div class="col-md-6">
                {{ form.start_date.label(class="form-label") }}
                {{ form.start_date(class="form-control") }}
                {% if form.start_date.errors %}
                    <div class="text-danger small">{{ form.start_date.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                {{ form.end_date.label(class="form-label") }}
                {{ form.end_date(class="form-control") }}
                {% if form.end_date.errors %}
                    <div class="text-danger small">{{ form.end_date.errors[0] }}</div>
                {% endif %}
            </div>
        </div>
        <div class="row g-3 mt-1">
            <div class="col-md-6">
                {{ form.items.label(class="form-label") }}
                {{ form.items(class="form-select", multiple=true) }}
                <div class="form-text">Leave blank to include all inventory items.</div>
                {% if form.items.errors %}
                    <div class="text-danger small">{{ form.items.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="col-md-6">
                {{ form.gl_codes.label(class="form-label") }}
                {{ form.gl_codes(class="form-select", multiple=true) }}
                <div class="form-text">Hold Ctrl (Windows) or Command (Mac) to select multiple GL codes.</div>
                {% if form.gl_codes.errors %}
                    <div class="text-danger small">{{ form.gl_codes.errors[0] }}</div>
                {% endif %}
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Generate Report</button>
    </form>

    {% if results is not none %}
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <h3 class="mb-0">Report Results</h3>
            {% if start and end %}
            <span class="text-muted">{{ start.strftime('%Y-%m-%d') }} to {{ end.strftime('%Y-%m-%d') }}</span>
            {% endif %}
        </div>

        {% if results %}
        {% if selected_item_names or selected_gl_labels %}
        <div class="alert alert-secondary" role="status">
            <div class="fw-semibold">Filters Applied</div>
            <ul class="mb-0 small">
                {% if selected_item_names %}
                <li><span class="fw-semibold">Items:</span> {{ selected_item_names | join(', ') }}</li>
                {% endif %}
                {% if selected_gl_labels %}
                <li><span class="fw-semibold">GL Codes:</span> {{ selected_gl_labels | join(', ') }}</li>
                {% endif %}
            </ul>
        </div>
        {% endif %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Item</th>
                        <th scope="col">GL Code</th>
                        <th scope="col">Unit</th>
                        <th scope="col" class="text-end">Purchased Qty</th>
                        <th scope="col" class="text-end">Purchased Spend</th>
                        <th scope="col" class="text-end">Used Qty</th>
                        <th scope="col" class="text-end">Used Value</th>
                        <th scope="col" class="text-end">Spoilage</th>
                        <th scope="col" class="text-end">Net Qty</th>
                        <th scope="col" class="text-end">Net Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr>
                        <td>{{ row.item_name }}</td>
                        <td>
                            {{ row.gl_code }}
                            {% if row.gl_description %}
                                <div class="text-muted small">{{ row.gl_description }}</div>
                            {% endif %}
                        </td>
                        <td>{{ row.unit_name }}</td>
                        <td class="text-end">{{ '%.2f'|format(row.purchased_quantity) }}</td>
                        <td class="text-end">${{ '%.2f'|format(row.purchased_value) }}</td>
                        <td class="text-end">{{ '%.2f'|format(row.used_quantity) }}</td>
                        <td class="text-end">${{ '%.2f'|format(row.used_value) }}</td>
                        <td class="text-end">
                            <div>{{ '%.2f'|format(row.spoilage_quantity) }}</div>
                            <div class="text-muted small">${{ '%.2f'|format(row.spoilage_value) }}</div>
                        </td>
                        <td class="text-end">{{ '%.2f'|format(row.net_quantity) }}</td>
                        <td class="text-end">${{ '%.2f'|format(row.net_value) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Totals</th>
                        <th class="text-end">{{ '%.2f'|format(totals.purchased_quantity) }}</th>
                        <th class="text-end">${{ '%.2f'|format(totals.purchased_value) }}</th>
                        <th class="text-end">{{ '%.2f'|format(totals.used_quantity) }}</th>
                        <th class="text-end">${{ '%.2f'|format(totals.used_value) }}</th>
                        <th class="text-end">
                            <div>{{ '%.2f'|format(totals.spoilage_quantity) }}</div>
                            <div class="text-muted small">${{ '%.2f'|format(totals.spoilage_value) }}</div>
                        </th>
                        <th class="text-end">{{ '%.2f'|format(totals.net_quantity) }}</th>
                        <th class="text-end">${{ '%.2f'|format(totals.net_value) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
            <div class="alert alert-info" role="alert">
                No purchase or usage records matched the selected filters.
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}
