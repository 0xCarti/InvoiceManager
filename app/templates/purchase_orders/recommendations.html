{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Purchase Order Recommendations</h2>

    <form method="get" class="row g-3 align-items-end mb-4">
        <div class="col-md-2">
            <label for="lookback_days" class="form-label">Lookback (days)</label>
            <input type="number" class="form-control" id="lookback_days" name="lookback_days"
                   value="{{ lookback_days }}" min="1">
        </div>
        <div class="col-md-2">
            <label for="lead_time_days" class="form-label">Lead Time (days)</label>
            <input type="number" class="form-control" id="lead_time_days" name="lead_time_days"
                   value="{{ lead_time_days }}" min="0">
        </div>
        <div class="col-md-3">
            <label for="location_id" class="form-label">Location</label>
            <select name="location_id" id="location_id" class="form-select">
                <option value="">All Locations</option>
                {% for location in locations %}
                <option value="{{ location.id }}" {% if selected_location == location.id %}selected{% endif %}>{{ location.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="item_id" class="form-label">Item</label>
            <input type="number" class="form-control" id="item_id" name="item_id" value="{{ selected_item or '' }}"
                   placeholder="Item ID">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Refresh</button>
        </div>
        <div class="col-md-3">
            <label for="attendance_multiplier" class="form-label">Attendance Multiplier</label>
            <input type="number" step="0.1" min="0" class="form-control" id="attendance_multiplier"
                   name="attendance_multiplier" value="{{ '%.2f'|format(attendance_multiplier) }}">
        </div>
        <div class="col-md-3">
            <label for="weather_multiplier" class="form-label">Weather Multiplier</label>
            <input type="number" step="0.1" min="0" class="form-control" id="weather_multiplier"
                   name="weather_multiplier" value="{{ '%.2f'|format(weather_multiplier) }}">
        </div>
        <div class="col-md-3">
            <label for="promo_multiplier" class="form-label">Promotion Multiplier</label>
            <input type="number" step="0.1" min="0" class="form-control" id="promo_multiplier"
                   name="promo_multiplier" value="{{ '%.2f'|format(promo_multiplier) }}">
        </div>
    </form>

    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="table-responsive">
                <table class="table table-striped table-sm align-middle">
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Location</th>
                        <th>Sales</th>
                        <th>Transfers In</th>
                        <th>Transfers Out</th>
                        <th>Invoices</th>
                        <th>Open POs</th>
                        <th>Base Demand</th>
                        <th>Adjusted Demand</th>
                        <th>Suggested Qty</th>
                        <th>Suggested Delivery</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for rec in recommendations %}
                    <tr>
                        <td>{{ rec.item.name }}</td>
                        <td>{{ rec.location.name }}</td>
                        <td>{{ '%.2f'|format(rec.history['sales_qty']) }}</td>
                        <td>{{ '%.2f'|format(rec.history['transfer_in_qty']) }}</td>
                        <td>{{ '%.2f'|format(rec.history['transfer_out_qty']) }}</td>
                        <td>{{ '%.2f'|format(rec.history['invoice_qty']) }}</td>
                        <td>{{ '%.2f'|format(rec.history['open_po_qty']) }}</td>
                        <td>{{ '%.2f'|format(rec.base_consumption) }}</td>
                        <td>{{ '%.2f'|format(rec.adjusted_demand) }}</td>
                        <td>{{ '%.2f'|format(rec.recommended_quantity) }}</td>
                        <td>{{ rec.suggested_delivery_date.strftime('%Y-%m-%d') }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" class="text-center">No recommendations available for the selected criteria.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-lg-4">
            <canvas id="recommendation-chart" height="240"></canvas>
        </div>
    </div>

    {% if recommendations %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Push to Draft Purchase Order</h5>
            <form method="post">
                <input type="hidden" name="action" value="seed">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="seed_vendor_id" class="form-label">Vendor</label>
                        <select name="seed_vendor_id" id="seed_vendor_id" class="form-select" required>
                            <option value="">Select a vendor</option>
                            {% for vendor in vendors %}
                            <option value="{{ vendor.id }}" {% if selected_vendor == vendor.id %}selected{% endif %}>{{ vendor.first_name }} {{ vendor.last_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="seed_order_date" class="form-label">Order Date</label>
                        <input type="date" class="form-control" id="seed_order_date" name="seed_order_date"
                               value="{{ today.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="col-md-3">
                        <label for="seed_expected_date" class="form-label">Expected Delivery</label>
                        <input type="date" class="form-control" id="seed_expected_date" name="seed_expected_date"
                               value="{{ recommendations[0].suggested_delivery_date.strftime('%Y-%m-%d') if recommendations else '' }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">Create Draft</button>
                    </div>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table table-bordered table-sm align-middle">
                        <thead>
                        <tr>
                            <th scope="col">Include</th>
                            <th scope="col">Item</th>
                            <th scope="col">Location</th>
                            <th scope="col">Suggested Qty</th>
                            <th scope="col">Override Qty</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for rec in recommendations %}
                        {% set key = rec.item.id ~ ':' ~ rec.location.id %}
                        <tr>
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input" name="selected_lines" value="{{ key }}">
                            </td>
                            <td>{{ rec.item.name }}</td>
                            <td>{{ rec.location.name }}</td>
                            <td>{{ '%.2f'|format(rec.recommended_quantity) }}</td>
                            <td>
                                <input type="number" step="0.01" min="0" class="form-control form-control-sm"
                                       name="override-{{ key }}" value="{{ '%.2f'|format(rec.recommended_quantity) }}">
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function () {
    const rows = {{ chart_rows|tojson }};
    const ctx = document.getElementById('recommendation-chart');
    if (!ctx || !rows.length) {
        return;
    }
    const labels = rows.map(row => row.label);
    const data = {
        labels,
        datasets: [
            {
                label: 'Adjusted Demand',
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                data: rows.map(row => row.consumption),
            },
            {
                label: 'Incoming Supply',
                backgroundColor: 'rgba(25, 135, 84, 0.7)',
                data: rows.map(row => row.incoming),
            },
            {
                label: 'Recommended Qty',
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                data: rows.map(row => row.recommended),
            }
        ]
    };
    new Chart(ctx, {
        type: 'bar',
        data,
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}
