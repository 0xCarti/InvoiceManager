{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Receive Invoice for PO {{ po.id }}</h2>
    <style>
        .item-row .item-col {
            flex: 2 1 260px;
            min-width: 220px;
        }

        .item-row .unit-col {
            flex: 0 0 auto;
        }

        .item-row .unit-col .unit-select {
            width: auto;
            min-width: 7rem;
        }

        .item-row .quantity-col,
        .item-row .cost-col {
            flex: 1 1 140px;
            min-width: 120px;
        }

        .item-row .gl-code-col {
            flex: 1 1 200px;
            min-width: 180px;
        }

        .item-row .location-col {
            flex: 1 1 200px;
            min-width: 180px;
        }

        .item-row .line-total-col {
            flex: 0 0 110px;
            min-width: 100px;
        }

        .item-row .move-button-stack .btn {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .item-row .item-col,
            .item-row .unit-col,
            .item-row .quantity-col,
            .item-row .cost-col,
            .item-row .location-col,
            .item-row .gl-code-col,
            .item-row .line-total-col {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .item-row .unit-col .unit-select {
                width: 100%;
            }

            .item-row .gl-code-col .gl-code-select {
                width: 100%;
            }
        }
    </style>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.received_date.label(class="form-label") }}
            {{ form.received_date(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.gst.label(class="form-label") }}
            {{ form.gst(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.location_id.label(class="form-label") }}
            {{ form.location_id(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.department.label(class="form-label") }}
            {{ form.department(class="form-select narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.pst.label(class="form-label") }}
            {{ form.pst(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.delivery_charge.label(class="form-label") }}
            {{ form.delivery_charge(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.invoice_number.label(class="form-label") }}
            {{ form.invoice_number(class="form-control narrow-field") }}
        </div>
        <h4>Items</h4>
        <div id="items">
        {% for item in form.items %}
        <div class="row g-2 item-row mb-2 align-items-center">
            <div class="col item-col">
                {{ item.item(class="form-control item-select") }}
                <input type="hidden" name="items-{{ loop.index0 }}-position" class="item-position" value="{{ item.position.data or loop.index0 }}">
            </div>
            <div class="col-auto unit-col"><select name="items-{{ loop.index0 }}-unit" class="form-control unit-select" data-selected="{{ item.unit.data }}"></select></div>
            <div class="col quantity-col">{{ item.quantity(class="form-control quantity") }}</div>
            <div class="col cost-col">{{ item.cost(class="form-control cost") }}</div>
            <div class="col location-col">{{ item.location_id(class="form-select location-select", **{"data-selected": item.location_id.data}) }}</div>
            <div class="col gl-code-col">{{ item.gl_code(class="form-control gl-code-select") }}</div>
            <div class="col line-total-col"><span class="line-total">0.00</span></div>
            <div class="col-auto">
                <div class="d-flex flex-column gap-1 move-button-stack">
                    <button type="button" class="btn btn-outline-secondary btn-sm move-up drag-handle" aria-label="Move item up" title="Move item up">=</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm move-down drag-handle" aria-label="Move item down" title="Move item down">=</button>
                </div>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-danger remove-item">Remove</button>
            </div>
        </div>
        {% endfor %}
        </div>
        <button id="add-item" type="button" class="btn btn-secondary mt-3">Add Item</button>
        <div class="form-group mt-3">
            <label>Item Total: $<span id="item-total">0.00</span></label>
        </div>
        <div class="form-group mt-3">
            <label>Grand Total: $<span id="grand-total">0.00</span></label>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>
</div>
<script nonce="{{ csp_nonce }}">
    const itemOptions = `<option value="">Select Item</option>{% for val, label in form.items[0].item.choices %}<option value="{{ val }}">{{ label }}</option>{% endfor %}`;
    const glCodeOptions = `{% for val, label in gl_code_choices %}<option value="{{ val }}">{{ label|e }}</option>{% endfor %}`;
    const locationOptions = `{% for val, label in form.items[0].location_id.choices %}<option value="{{ val }}">{{ label|e }}</option>{% endfor %}`;
    let itemIndex = {{ form.items|length }};

    function createRow(index) {
        const row = document.createElement('div');
        row.classList.add('row','g-2','mb-2','item-row','align-items-center');
        row.innerHTML = `
            <div class="col item-col">
                <select name="items-${index}-item" id="items-${index}-item" class="form-control item-select">${itemOptions}</select>
                <input type="hidden" name="items-${index}-position" class="item-position" value="">
            </div>
            <div class="col-auto unit-col"><select name="items-${index}-unit" id="items-${index}-unit" class="form-control unit-select" data-selected=""></select></div>
            <div class="col quantity-col"><input type="number" step="any" name="items-${index}-quantity" id="items-${index}-quantity" class="form-control quantity"></div>
            <div class="col cost-col"><input type="number" step="any" name="items-${index}-cost" id="items-${index}-cost" class="form-control cost"></div>
            <div class="col location-col"><select name="items-${index}-location_id" id="items-${index}-location_id" class="form-select location-select">${locationOptions}</select></div>
            <div class="col gl-code-col"><select name="items-${index}-gl_code" id="items-${index}-gl_code" class="form-control gl-code-select">${glCodeOptions}</select></div>
            <div class="col line-total-col"><span class="line-total">0.00</span></div>
            <div class="col-auto">
                <div class="d-flex flex-column gap-1 move-button-stack">
                    <button type="button" class="btn btn-outline-secondary btn-sm move-up drag-handle" aria-label="Move item up" title="Move item up">=</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm move-down drag-handle" aria-label="Move item down" title="Move item down">=</button>
                </div>
            </div>
            <div class="col-auto"><button type="button" class="btn btn-danger remove-item">Remove</button></div>
        `;
        return row;
    }

    function getInvoiceLocationValue() {
        const field = document.getElementById('location_id');
        return field ? field.value : '';
    }

    function getRowLocationId(row) {
        const select = row.querySelector('.location-select');
        if (select) {
            const value = select.value;
            if (value && value !== '0') {
                return value;
            }
        }
        return getInvoiceLocationValue();
    }

    function updatePositions() {
        const rows = Array.from(document.querySelectorAll('#items .item-row'));
        rows.forEach((row, index) => {
            const positionInput = row.querySelector('.item-position');
            if (positionInput) {
                positionInput.value = index;
            }
            const moveUp = row.querySelector('.move-up');
            if (moveUp) {
                moveUp.disabled = index === 0;
            }
            const moveDown = row.querySelector('.move-down');
            if (moveDown) {
                moveDown.disabled = index === rows.length - 1;
            }
        });
    }

    function fetchCost(row) {
        const itemId = row.querySelector('.item-select').value;
        const unitId = row.querySelector('.unit-select').value;
        if (!itemId) return;
        fetch(`/items/${itemId}/last_cost?unit_id=${unitId}`).then(r=>r.json()).then(d=>{
            const input = row.querySelector('.cost');
            if (!input.dataset.touched) {
                input.value = parseFloat(d.cost).toFixed(2);
            }
            updateTotals();
        });
    }

    function fetchUnits(selectEl, selectedUnitId=null) {
        const itemId = selectEl.value;
        const row = selectEl.closest('.item-row');
        const unitSelect = row.querySelector('.unit-select');
        if (!itemId) {
            unitSelect.innerHTML = '';
            applyDefaultGlCode(row, null);
            return;
        }
        const params = new URLSearchParams();
        const effectiveLocation = getRowLocationId(row);
        if (effectiveLocation) {
            params.append('location_id', effectiveLocation);
        }
        const url = params.toString() ? `/items/${itemId}/units?${params.toString()}` : `/items/${itemId}/units`;
        fetch(url).then(r => r.json()).then(data => {
            let opts = '';
            data.units.forEach(u => {
                const selected = (selectedUnitId && parseInt(selectedUnitId) === u.id) || (!selectedUnitId && u.receiving_default) ? 'selected' : '';
                opts += `<option value="${u.id}" ${selected}>${u.name}</option>`;
            });
            unitSelect.innerHTML = opts;
            applyDefaultGlCode(row, data.purchase_gl_code);
            fetchCost(selectEl.closest('.item-row'));
        });
    }

    function applyDefaultGlCode(row, glData) {
        const glSelect = row ? row.querySelector('.gl-code-select') : null;
        if (!glSelect) return;
        const defaultValue = glData && glData.id ? String(glData.id) : '0';
        glSelect.dataset.defaultValue = defaultValue;
        if (glSelect.dataset.userSelected === '1') {
            return;
        }
        glSelect.value = defaultValue;
    }

    function updateTotals() {
        let total = 0;
        document.querySelectorAll('#items .item-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.quantity').value) || 0;
            const price = parseFloat(row.querySelector('.cost').value) || 0;
            const lineTotal = qty * price;
            row.querySelector('.line-total').textContent = lineTotal.toFixed(2);
            total += lineTotal;
        });
        document.getElementById('item-total').textContent = total.toFixed(2);
        const gst = parseFloat(document.getElementById('gst').value) || 0;
        const pst = parseFloat(document.getElementById('pst').value) || 0;
        const del = parseFloat(document.getElementById('delivery_charge').value) || 0;
        document.getElementById('grand-total').textContent = (total + gst + pst + del).toFixed(2);
    }

    document.getElementById('add-item').addEventListener('click', function(e) {
        e.preventDefault();
        const row = createRow(itemIndex);
        document.getElementById('items').appendChild(row);
        const glSelect = row.querySelector('.gl-code-select');
        if (glSelect) {
            glSelect.value = '0';
        }
        const locationSelect = row.querySelector('.location-select');
        if (locationSelect) {
            locationSelect.value = '0';
        }
        itemIndex++;
        updatePositions();
    });

    document.getElementById('items').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-item')) {
            e.target.closest('.item-row').remove();
            updatePositions();
            updateTotals();
        } else if (e.target && e.target.classList.contains('move-up')) {
            const row = e.target.closest('.item-row');
            const prev = row ? row.previousElementSibling : null;
            if (row && prev) {
                row.parentElement.insertBefore(row, prev);
                updatePositions();
            }
        } else if (e.target && e.target.classList.contains('move-down')) {
            const row = e.target.closest('.item-row');
            const next = row ? row.nextElementSibling : null;
            if (row && next) {
                row.parentElement.insertBefore(next, row);
                updatePositions();
            }
        }
    });

    document.getElementById('items').addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('item-select')) {
            fetchUnits(e.target);
        }
        if (e.target && e.target.classList.contains('unit-select')) {
            fetchCost(e.target.closest('.item-row'));
        }
        if (e.target && e.target.classList.contains('gl-code-select')) {
            e.target.dataset.userSelected = '1';
        }
        if (e.target && e.target.classList.contains('location-select')) {
            if (e.target.value === '0') {
                delete e.target.dataset.userSelected;
            } else {
                e.target.dataset.userSelected = '1';
            }
            const row = e.target.closest('.item-row');
            const itemSelect = row.querySelector('.item-select');
            if (itemSelect && itemSelect.value) {
                const unitSelect = row.querySelector('.unit-select');
                const selectedUnit = unitSelect ? unitSelect.value : null;
                fetchUnits(itemSelect, selectedUnit);
            } else {
                applyDefaultGlCode(row, null);
            }
        }
        if (e.target && (e.target.classList.contains('quantity') || e.target.classList.contains('cost'))) {
            updateTotals();
        }
    });

    const locationField = document.getElementById('location_id');
    if (locationField) {
        locationField.addEventListener('change', () => {
            document.querySelectorAll('#items .item-row').forEach(row => {
                const itemSelect = row.querySelector('.item-select');
                if (itemSelect && itemSelect.value) {
                    const unitSelect = row.querySelector('.unit-select');
                    const selectedUnit = unitSelect ? unitSelect.value : null;
                    fetchUnits(itemSelect, selectedUnit);
                } else {
                    applyDefaultGlCode(row, null);
                }
            });
        });
    }

    document.getElementById('items').addEventListener('input', function(e) {
        if (e.target && (e.target.classList.contains('quantity') || e.target.classList.contains('cost'))) {
            if (e.target.classList.contains('cost')) { e.target.dataset.touched = '1'; }
            updateTotals();
        }
    });

    document.getElementById('items').addEventListener('keydown', function(e) {
        if (
            e.target &&
            e.target.classList.contains('cost') &&
            e.key === 'Tab' &&
            !e.shiftKey
        ) {
            const nextRow = e.target.closest('.item-row').nextElementSibling;
            if (nextRow && nextRow.querySelector('.cost')) {
                e.preventDefault();
                const nextCost = nextRow.querySelector('.cost');
                nextCost.focus();
                nextCost.select();
            }
        }
    });

    document.querySelectorAll('.gl-code-select').forEach(sel => {
        if (sel.value && sel.value !== '0') {
            sel.dataset.userSelected = '1';
        }
    });

    document.querySelectorAll('.item-select').forEach(sel => {
        const row = sel.closest('.item-row');
        const selectedUnit = row.querySelector('.unit-select').dataset.selected;
        const locationSelect = row.querySelector('.location-select');
        if (locationSelect) {
            const selectedLocation = locationSelect.dataset.selected;
            if (selectedLocation) {
                locationSelect.value = selectedLocation;
                if (selectedLocation !== '0') {
                    locationSelect.dataset.userSelected = '1';
                }
            } else {
                locationSelect.value = '0';
            }
        }
        fetchUnits(sel, selectedUnit);
        const glSelect = row.querySelector('.gl-code-select');
        if (glSelect && !glSelect.value) {
            glSelect.value = '0';
        }
    });
    document.getElementById('gst').addEventListener('input', updateTotals);
    document.getElementById('pst').addEventListener('input', updateTotals);
    document.getElementById('delivery_charge').addEventListener('input', updateTotals);
    updatePositions();
    updateTotals();
</script>
{% endblock %}
