{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Receive Invoice for PO {{ po.id }}</h2>
    <style>
        .item-row .item-col {
            flex: 2 1 260px;
            min-width: 220px;
        }

        .item-row .unit-col {
            flex: 0 0 auto;
        }

        .item-row .unit-col .unit-select {
            width: auto;
            min-width: 7rem;
        }

        .item-row .quantity-col,
        .item-row .cost-col,
        .item-row .deposit-col {
            flex: 1 1 140px;
            min-width: 120px;
        }

        .item-row .line-total-col {
            flex: 0 0 110px;
            min-width: 100px;
        }

        .item-row .move-button-stack .btn {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .item-row .item-col,
            .item-row .unit-col,
            .item-row .quantity-col,
            .item-row .cost-col,
            .item-row .line-total-col {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .item-row .unit-col .unit-select {
                width: 100%;
            }
        }

        .item-row .optional-panel {
            display: none;
            border-left: 4px solid #e9ecef;
            background: #f8f9fa;
            padding: 0.75rem 0.75rem 0.5rem;
            border-radius: 0.25rem;
        }

        .item-row .optional-panel.show {
            display: block;
        }
    </style>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.received_date.label(class="form-label") }}
            {{ form.received_date(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.gst.label(class="form-label") }}
            {{ form.gst(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.location_id.label(class="form-label") }}
            {{ form.location_id(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.department.label(class="form-label") }}
            {{ form.department(class="form-select narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.pst.label(class="form-label") }}
            {{ form.pst(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.delivery_charge.label(class="form-label") }}
            {{ form.delivery_charge(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.invoice_number.label(class="form-label") }}
            {{ form.invoice_number(class="form-control narrow-field") }}
        </div>
        <h4>Items</h4>
        <div id="items">
        {% for item in form.items %}
        <div class="row g-2 item-row mb-2 align-items-center">
            <div class="col item-col">
                {{ item.item(class="form-control item-select") }}
                <input type="hidden" name="items-{{ loop.index0 }}-position" class="item-position" value="{{ item.position.data or loop.index0 }}">
            </div>
            <div class="col-auto unit-col">
                <select name="items-{{ loop.index0 }}-unit" class="form-control unit-select" data-selected="{{ item.unit.data }}">
                    {% for val, label in item.unit.choices %}
                        <option value="{{ val }}" {% if val == item.unit.data %}selected{% endif %}>{{ label|e }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col quantity-col">{{ item.quantity(class="form-control quantity") }}</div>
            <div class="col cost-col">{{ item.cost(class="form-control cost") }}</div>
            <div class="col line-total-col"><span class="line-total">0.00</span></div>
            <div class="col-auto">
                <div class="d-flex flex-column gap-1 move-button-stack">
                    <button type="button" class="btn btn-outline-secondary btn-sm move-up drag-handle" aria-label="Move item up" title="Move item up">=</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm move-down drag-handle" aria-label="Move item down" title="Move item down">=</button>
                </div>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-danger remove-item">Remove</button>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-outline-secondary btn-sm toggle-optional collapsed" aria-expanded="false">More</button>
            </div>
            <div class="col-12 optional-panel">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4 col-sm-6">
                        <div class="d-flex gap-2 align-items-center">
                            <button type="button" class="btn btn-outline-secondary btn-sm toggle-deposit" data-active="{% if item.container_deposit.data and item.container_deposit.data != 0 %}1{% else %}0{% endif %}">Add container deposit</button>
                            <div class="flex-grow-1 deposit-col {% if not item.container_deposit.data or item.container_deposit.data == 0 %}d-none{% endif %}">
                                {{ item.container_deposit(class="form-control deposit", **({'data-initial-enabled': '1'} if item.container_deposit.data and item.container_deposit.data != 0 else {'data-initial-enabled': '0', 'disabled': True})) }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <label class="form-label mb-1">Location</label>
                        {{ item.location_id(class="form-select location-select", **{"data-selected": item.location_id.data}) }}
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <label class="form-label mb-1">GL Code</label>
                        {{ item.gl_code(class="form-control gl-code-select") }}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
        <button id="add-item" type="button" class="btn btn-secondary mt-3">Add Item</button>
        <div class="form-group mt-3">
            <label>Item Total: $<span id="item-total">0.00</span></label>
        </div>
        <div class="form-group mt-3">
            <label>Grand Total: $<span id="grand-total">0.00</span></label>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>
</div>
<script src="{{ url_for('static', filename='js/date_pickers.js') }}"></script>
<script nonce="{{ csp_nonce }}">
    const departmentDefaults = {{ department_defaults|tojson }};
    const itemOptions = `<option value="">Select Item</option>{% for val, label in form.items[0].item.choices %}<option value="{{ val }}">{{ label }}</option>{% endfor %}`;
    const glCodeOptions = `{% for val, label in gl_code_choices %}<option value="{{ val }}">{{ label|e }}</option>{% endfor %}`;
    const locationOptions = `{% for val, label in form.items[0].location_id.choices %}<option value="{{ val }}">{{ label|e }}</option>{% endfor %}`;
    let itemIndex = {{ form.items|length }};
    const departmentField = document.getElementById('department');
    const invoiceLocationField = document.getElementById('location_id');

    initDatePickers({
        fieldSelectors: ['#{{ form.received_date.id }}']
    });

    function applyDepartmentDefault(department, { skipIfSet = false } = {}) {
        if (!invoiceLocationField) {
            return;
        }
        const defaultLocation = departmentDefaults && departmentDefaults[department];
        if (!defaultLocation) {
            return;
        }
        if (skipIfSet && invoiceLocationField.value) {
            return;
        }
        const targetValue = String(defaultLocation);
        const hasOption = Array.from(invoiceLocationField.options).some(
            (option) => option.value === targetValue
        );
        if (!hasOption) {
            return;
        }
        invoiceLocationField.value = targetValue;
        invoiceLocationField.dispatchEvent(new Event('change', { bubbles: true }));
    }

    if (departmentField) {
        applyDepartmentDefault(departmentField.value, { skipIfSet: true });
        departmentField.addEventListener('change', () => {
            applyDepartmentDefault(departmentField.value);
        });
    }

    function createRow(index) {
        const row = document.createElement('div');
        row.classList.add('row','g-2','mb-2','item-row','align-items-center');
        row.innerHTML = `
            <div class="col item-col">
                <select name="items-${index}-item" id="items-${index}-item" class="form-control item-select">${itemOptions}</select>
                <input type="hidden" name="items-${index}-position" class="item-position" value="">
            </div>
            <div class="col-auto unit-col"><select name="items-${index}-unit" id="items-${index}-unit" class="form-control unit-select" data-selected=""></select></div>
            <div class="col quantity-col"><input type="text" name="items-${index}-quantity" id="items-${index}-quantity" class="form-control quantity" inputmode="decimal" data-numeric-input="1"></div>
            <div class="col cost-col"><input type="text" name="items-${index}-cost" id="items-${index}-cost" class="form-control cost" inputmode="decimal" data-numeric-input="1"></div>
            <div class="col line-total-col"><span class="line-total">0.00</span></div>
            <div class="col-auto">
                <div class="d-flex flex-column gap-1 move-button-stack">
                    <button type="button" class="btn btn-outline-secondary btn-sm move-up drag-handle" aria-label="Move item up" title="Move item up">=</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm move-down drag-handle" aria-label="Move item down" title="Move item down">=</button>
                </div>
            </div>
            <div class="col-auto"><button type="button" class="btn btn-danger remove-item">Remove</button></div>
            <div class="col-auto"><button type="button" class="btn btn-outline-secondary btn-sm toggle-optional collapsed" aria-expanded="false">More</button></div>
            <div class="col-12 optional-panel">
                <div class="row g-2 align-items-end">
                    <div class="col-md-4 col-sm-6">
                        <div class="d-flex gap-2 align-items-center">
                            <button type="button" class="btn btn-outline-secondary btn-sm toggle-deposit" data-active="0">Add container deposit</button>
                            <div class="flex-grow-1 deposit-col d-none"><input type="text" name="items-${index}-container_deposit" id="items-${index}-container_deposit" class="form-control deposit" inputmode="decimal" data-numeric-input="1" data-initial-enabled="0" disabled></div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <label class="form-label mb-1">Location</label>
                        <select name="items-${index}-location_id" id="items-${index}-location_id" class="form-select location-select">${locationOptions}</select>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <label class="form-label mb-1">GL Code</label>
                        <select name="items-${index}-gl_code" id="items-${index}-gl_code" class="form-control gl-code-select">${glCodeOptions}</select>
                    </div>
                </div>
            </div>
        `;
        return row;
    }

    function getInvoiceLocationValue() {
        const field = document.getElementById('location_id');
        return field ? field.value : '';
    }

    function getRowLocationId(row) {
        const select = row.querySelector('.location-select');
        if (select) {
            const value = select.value;
            if (value && value !== '0') {
                return value;
            }
        }
        return getInvoiceLocationValue();
    }

    function updatePositions() {
        const rows = Array.from(document.querySelectorAll('#items .item-row'));
        rows.forEach((row, index) => {
            const positionInput = row.querySelector('.item-position');
            if (positionInput) {
                positionInput.value = index;
            }
            const moveUp = row.querySelector('.move-up');
            if (moveUp) {
                moveUp.disabled = index === 0;
            }
            const moveDown = row.querySelector('.move-down');
            if (moveDown) {
                moveDown.disabled = index === rows.length - 1;
            }
        });
    }

    function fetchCost(row) {
        const itemId = row.querySelector('.item-select').value;
        const unitId = row.querySelector('.unit-select').value;
        if (!itemId) return;
        fetch(`/items/${itemId}/last_cost?unit_id=${unitId}`).then(r=>r.json()).then(d=>{
            const input = row.querySelector('.cost');
            if (!input.dataset.touched) {
                input.value = parseFloat(d.cost).toFixed(2);
            }
            const depositInput = row.querySelector('.deposit');
            if (depositInput && !depositInput.dataset.touched) {
                const depositValue = Number.isFinite(parseFloat(d.deposit)) ? parseFloat(d.deposit) : 0;
                depositInput.value = depositValue.toFixed(2);
            }
            updateTotals();
        });
    }

    function setDepositVisibility(row, enabled) {
        const depositCol = row.querySelector('.deposit-col');
        const depositInput = row.querySelector('.deposit');
        const toggleBtn = row.querySelector('.toggle-deposit');
        if (enabled) {
            depositCol?.classList.remove('d-none');
            if (depositInput) {
                depositInput.disabled = false;
            }
            if (toggleBtn) {
                toggleBtn.dataset.active = '1';
                toggleBtn.textContent = 'Remove container deposit';
            }
        } else {
            depositCol?.classList.add('d-none');
            if (depositInput) {
                depositInput.disabled = true;
            }
            if (toggleBtn) {
                toggleBtn.dataset.active = '0';
                toggleBtn.textContent = 'Add container deposit';
            }
        }
    }

    function initDeposit(row) {
        const depositInput = row.querySelector('.deposit');
        const initialEnabled = depositInput && depositInput.dataset.initialEnabled === '1';
        setDepositVisibility(row, initialEnabled);
    }

    function setOptionalPanelState(row, expanded) {
        const optionalPanel = row.querySelector('.optional-panel');
        const toggleBtn = row.querySelector('.toggle-optional');
        if (!optionalPanel || !toggleBtn) {
            return;
        }
        if (expanded) {
            optionalPanel.classList.add('show');
            toggleBtn.classList.remove('collapsed');
            toggleBtn.setAttribute('aria-expanded', 'true');
        } else {
            optionalPanel.classList.remove('show');
            toggleBtn.classList.add('collapsed');
            toggleBtn.setAttribute('aria-expanded', 'false');
        }
    }

    function shouldExpandOptional(row) {
        const depositToggle = row.querySelector('.toggle-deposit');
        const depositInput = row.querySelector('.deposit');
        const depositActive = (depositToggle && depositToggle.dataset.active === '1') ||
            (depositInput && !depositInput.disabled && depositInput.value && depositInput.value !== '0' && depositInput.value !== '0.00');

        const locationSelect = row.querySelector('.location-select');
        const hasLocation = locationSelect && locationSelect.value && locationSelect.value !== '0';

        const glSelect = row.querySelector('.gl-code-select');
        const defaultGl = glSelect ? glSelect.dataset.defaultValue : null;
        const glDiffers = glSelect && glSelect.value && defaultGl && glSelect.value !== defaultGl;

        return Boolean(depositActive || hasLocation || glDiffers);
    }

    function fetchUnits(selectEl, selectedUnitId=null) {
        const itemId = selectEl.value;
        const row = selectEl.closest('.item-row');
        const unitSelect = row.querySelector('.unit-select');
        if (!itemId) {
            unitSelect.innerHTML = '';
            applyDefaultGlCode(row, null);
            return;
        }
        const params = new URLSearchParams();
        const effectiveLocation = getRowLocationId(row);
        if (effectiveLocation) {
            params.append('location_id', effectiveLocation);
        }
        const url = params.toString() ? `/items/${itemId}/units?${params.toString()}` : `/items/${itemId}/units`;
        fetch(url).then(r => r.json()).then(data => {
            let opts = '';
            data.units.forEach(u => {
                const selected = (selectedUnitId && parseInt(selectedUnitId) === u.id) || (!selectedUnitId && u.receiving_default) ? 'selected' : '';
                opts += `<option value="${u.id}" ${selected}>${u.name}</option>`;
            });
            unitSelect.innerHTML = opts;
            applyDefaultGlCode(row, data.purchase_gl_code);
            fetchCost(selectEl.closest('.item-row'));
        });
    }

    function applyDefaultGlCode(row, glData) {
        const glSelect = row ? row.querySelector('.gl-code-select') : null;
        if (!glSelect) return;
        const defaultValue = glData && glData.id ? String(glData.id) : '0';
        glSelect.dataset.defaultValue = defaultValue;
        if (glSelect.dataset.userSelected === '1') {
            return;
        }
        glSelect.value = defaultValue;
    }

    function parseNumber(value, defaultValue = 0) {
        if (window.NumericInput) {
            const parsed = window.NumericInput.parseValue(value);
            return Number.isFinite(parsed) ? parsed : defaultValue;
        }
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? parsed : defaultValue;
    }

    function updateTotals() {
        let total = 0;
        document.querySelectorAll('#items .item-row').forEach(row => {
            const qty = parseNumber(row.querySelector('.quantity').value, 0);
            const price = parseNumber(row.querySelector('.cost').value, 0);
            const depositInput = row.querySelector('.deposit');
            const deposit = depositInput && !depositInput.disabled ? parseNumber(depositInput.value, 0) : 0;
            const lineTotal = qty * (price + deposit);
            row.querySelector('.line-total').textContent = lineTotal.toFixed(2);
            total += lineTotal;
        });
        document.getElementById('item-total').textContent = total.toFixed(2);
        const gst = parseNumber(document.getElementById('gst').value, 0);
        const pst = parseNumber(document.getElementById('pst').value, 0);
        const del = parseNumber(document.getElementById('delivery_charge').value, 0);
        document.getElementById('grand-total').textContent = (total + gst + pst + del).toFixed(2);
    }

    document.getElementById('add-item').addEventListener('click', function(e) {
        e.preventDefault();
        const row = createRow(itemIndex);
        document.getElementById('items').appendChild(row);
        if (window.NumericInput) {
            window.NumericInput.enableWithin(row);
        }
        initDeposit(row);
        const glSelect = row.querySelector('.gl-code-select');
        if (glSelect) {
            glSelect.value = '0';
        }
        const locationSelect = row.querySelector('.location-select');
        if (locationSelect) {
            locationSelect.value = '0';
        }
        setOptionalPanelState(row, false);
        itemIndex++;
        updatePositions();
    });

    document.getElementById('items').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-item')) {
            e.target.closest('.item-row').remove();
            updatePositions();
            updateTotals();
        } else if (e.target && e.target.classList.contains('move-up')) {
            const row = e.target.closest('.item-row');
            const prev = row ? row.previousElementSibling : null;
            if (row && prev) {
                row.parentElement.insertBefore(row, prev);
                updatePositions();
            }
        } else if (e.target && e.target.classList.contains('move-down')) {
            const row = e.target.closest('.item-row');
            const next = row ? row.nextElementSibling : null;
            if (row && next) {
                row.parentElement.insertBefore(next, row);
                updatePositions();
            }
        } else if (e.target && e.target.classList.contains('toggle-deposit')) {
            const row = e.target.closest('.item-row');
            if (row) {
                const isActive = e.target.dataset.active === '1';
                setDepositVisibility(row, !isActive);
                if (!isActive) {
                    setOptionalPanelState(row, true);
                }
                updateTotals();
            }
        } else if (e.target && e.target.classList.contains('toggle-optional')) {
            const row = e.target.closest('.item-row');
            if (row) {
                const optionalPanel = row.querySelector('.optional-panel');
                const expanded = optionalPanel && optionalPanel.classList.contains('show');
                setOptionalPanelState(row, !expanded);
            }
        }
    });

    document.getElementById('items').addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('item-select')) {
            fetchUnits(e.target);
        }
        if (e.target && e.target.classList.contains('unit-select')) {
            fetchCost(e.target.closest('.item-row'));
        }
        if (e.target && e.target.classList.contains('gl-code-select')) {
            e.target.dataset.userSelected = '1';
        }
        if (e.target && e.target.classList.contains('location-select')) {
            if (e.target.value === '0') {
                delete e.target.dataset.userSelected;
            } else {
                e.target.dataset.userSelected = '1';
            }
            const row = e.target.closest('.item-row');
            const itemSelect = row.querySelector('.item-select');
            if (itemSelect && itemSelect.value) {
                const unitSelect = row.querySelector('.unit-select');
                const selectedUnit = unitSelect ? unitSelect.value : null;
                fetchUnits(itemSelect, selectedUnit);
            } else {
                applyDefaultGlCode(row, null);
            }
        }
        if (e.target && (e.target.classList.contains('quantity') || e.target.classList.contains('cost') || e.target.classList.contains('deposit'))) {
            updateTotals();
        }
    });

    const locationField = document.getElementById('location_id');
    if (locationField) {
        locationField.addEventListener('change', () => {
            document.querySelectorAll('#items .item-row').forEach(row => {
                const itemSelect = row.querySelector('.item-select');
                if (itemSelect && itemSelect.value) {
                    const unitSelect = row.querySelector('.unit-select');
                    const selectedUnit = unitSelect ? unitSelect.value : null;
                    fetchUnits(itemSelect, selectedUnit);
                } else {
                    applyDefaultGlCode(row, null);
                }
            });
        });
    }

    document.getElementById('items').addEventListener('input', function(e) {
        if (e.target && (e.target.classList.contains('quantity') || e.target.classList.contains('cost') || e.target.classList.contains('deposit'))) {
            if (e.target.classList.contains('cost') || e.target.classList.contains('deposit')) { e.target.dataset.touched = '1'; }
            updateTotals();
        }
    });

    document.getElementById('items').addEventListener('keydown', function(e) {
        if (
            e.target &&
            e.target.classList.contains('cost') &&
            e.key === 'Tab' &&
            !e.shiftKey
        ) {
            const nextRow = e.target.closest('.item-row').nextElementSibling;
            if (nextRow && nextRow.querySelector('.cost')) {
                e.preventDefault();
                const nextCost = nextRow.querySelector('.cost');
                nextCost.focus();
                nextCost.select();
            }
        }
    });

    document.querySelectorAll('.gl-code-select').forEach(sel => {
        if (sel.value && sel.value !== '0') {
            sel.dataset.userSelected = '1';
        }
    });

    document.querySelectorAll('.item-select').forEach(sel => {
        const row = sel.closest('.item-row');
        const selectedUnit = row.querySelector('.unit-select').dataset.selected;
        const locationSelect = row.querySelector('.location-select');
        if (locationSelect) {
            const selectedLocation = locationSelect.dataset.selected;
            if (selectedLocation) {
                locationSelect.value = selectedLocation;
                if (selectedLocation !== '0') {
                    locationSelect.dataset.userSelected = '1';
                }
            } else {
                locationSelect.value = '0';
            }
        }
        fetchUnits(sel, selectedUnit);
        const glSelect = row.querySelector('.gl-code-select');
        if (glSelect && !glSelect.value) {
            glSelect.value = '0';
        }
        initDeposit(row);
        setOptionalPanelState(row, shouldExpandOptional(row));
    });
    document.getElementById('gst').addEventListener('input', updateTotals);
    document.getElementById('pst').addEventListener('input', updateTotals);
    document.getElementById('delivery_charge').addEventListener('input', updateTotals);
    updatePositions();
    updateTotals();
</script>
{% endblock %}
