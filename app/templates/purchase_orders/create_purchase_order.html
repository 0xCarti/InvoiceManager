{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Create Purchase Order</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.vendor.label(class="form-label") }}
            {{ form.vendor(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.order_date.label(class="form-label") }}
            {{ form.order_date(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.expected_date.label(class="form-label") }}
            {{ form.expected_date(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.delivery_charge.label(class="form-label") }}
            {{ form.delivery_charge(class="form-control narrow-field") }}
        </div>
        <h4>Items</h4>
        <button id="quick-add-item" type="button" class="btn btn-link p-0">Create New Item</button>
        <div id="items">
        {% for item in form.items %}
        <div class="row g-2 mt-2 item-row align-items-center">
            <div class="col">{{ item.item(class="form-control item-select") }}</div>
            <div class="col"><select name="items-{{ loop.index0 }}-unit" class="form-control unit-select"></select></div>
            <div class="col">{{ item.quantity(class="form-control quantity") }}</div>
            <div class="col-auto">
                <button type="button" class="btn btn-danger remove-item">Remove</button>
            </div>
        </div>
        {% endfor %}
        </div>
        <button id="add-item" type="button" class="btn btn-secondary mt-3">Add Item</button>
        <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>

    <div class="modal fade" id="newItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-item-name" class="form-label">Name</label>
                        <input type="text" id="new-item-name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="new-item-gl-code" class="form-label">Purchase GL Code</label>
                        <select id="new-item-gl-code" class="form-select">
                            {% for code in gl_codes %}
                                <option value="{{ code.id }}">{{ code.code }}{% if code.description %} - {{ code.description }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new-item-base-unit" class="form-label">Base Unit</label>
                        <select id="new-item-base-unit" class="form-select">
                            <option value="ounce">Ounce</option>
                            <option value="gram">Gram</option>
                            <option value="each" selected>Each</option>
                            <option value="millilitre">Millilitre</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new-item-receiving-unit" class="form-label">Receiving Unit</label>
                        <input type="text" id="new-item-receiving-unit" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="new-item-receiving-factor" class="form-label">Receiving Ratio to Base Unit</label>
                        <input type="number" step="any" id="new-item-receiving-factor" class="form-control" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="new-item-transfer-unit" class="form-label">Transfer Unit</label>
                        <input type="text" id="new-item-transfer-unit" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="new-item-transfer-factor" class="form-label">Transfer Ratio to Base Unit</label>
                        <input type="number" step="any" id="new-item-transfer-factor" class="form-control" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="save-new-item" class="btn btn-primary">Save Item</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let itemOptions = `<option value="">Select Item</option>{% for val, label in form.items[0].item.choices %}<option value="{{ val }}">{{ label }}</option>{% endfor %}`;
    let itemIndex = {{ form.items|length }};

    function createRow(index) {
        const row = document.createElement('div');
        row.classList.add('row','g-2','mt-2','item-row','align-items-center');
        row.innerHTML = `
            <div class="col"><select name="items-${index}-item" class="form-control item-select">${itemOptions}</select></div>
            <div class="col"><select name="items-${index}-unit" class="form-control unit-select"></select></div>
            <div class="col"><input type="number" step="any" name="items-${index}-quantity" class="form-control quantity"></div>
            <div class="col-auto"><button type="button" class="btn btn-danger remove-item">Remove</button></div>
        `;
        return row;
    }

    function fetchUnits(selectEl) {
        const itemId = selectEl.value;
        const unitSelect = selectEl.closest('.item-row').querySelector('.unit-select');
        if (!itemId) {
            unitSelect.innerHTML = '';
            return;
        }
        fetch(`/items/${itemId}/units`).then(r => r.json()).then(units => {
            let opts = '';
            units.forEach(u => {
                opts += `<option value="${u.id}" ${u.receiving_default ? 'selected' : ''}>${u.name}</option>`;
            });
            unitSelect.innerHTML = opts;
        });
    }

    document.getElementById('add-item').addEventListener('click', function(e) {
        e.preventDefault();
        const row = createRow(itemIndex);
        document.getElementById('items').appendChild(row);
        itemIndex++;
    });

    document.getElementById('items').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-item')) {
            e.target.closest('.row').remove();
        }
    });

    document.getElementById('items').addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('item-select')) {
            fetchUnits(e.target);
        }
    });

    document.getElementById('items').addEventListener('keydown', function(e) {
        if (
            e.target &&
            e.target.classList.contains('quantity') &&
            e.key === 'Tab' &&
            !e.shiftKey
        ) {
            const nextRow = e.target.closest('.item-row').nextElementSibling;
            if (nextRow && nextRow.querySelector('.quantity')) {
                e.preventDefault();
                nextRow.querySelector('.quantity').focus();
            }
        }
    });

    document.getElementById('quick-add-item').addEventListener('click', function() {
        new bootstrap.Modal(document.getElementById('newItemModal')).show();
    });

    document.getElementById('save-new-item').addEventListener('click', function() {
        const name = document.getElementById('new-item-name').value.trim();
        const glCode = document.getElementById('new-item-gl-code').value;
        const baseUnit = document.getElementById('new-item-base-unit').value;
        const recvUnit = document.getElementById('new-item-receiving-unit').value.trim();
        const recvFactor = parseFloat(document.getElementById('new-item-receiving-factor').value) || 0;
        const transUnit = document.getElementById('new-item-transfer-unit').value.trim();
        const transFactor = parseFloat(document.getElementById('new-item-transfer-factor').value) || 0;
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        if (!name || !recvUnit || !transUnit || recvFactor <= 0 || transFactor <= 0) return;
        fetch('/items/quick_add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify({
                name: name,
                purchase_gl_code: glCode,
                base_unit: baseUnit,
                receiving_unit: recvUnit,
                receiving_factor: recvFactor,
                transfer_unit: transUnit,
                transfer_factor: transFactor
            })
        }).then(r => r.json()).then(data => {
            if (data.id) {
                itemOptions += `<option value="${data.id}">${data.name}</option>`;
                document.querySelectorAll('.item-select').forEach(sel => {
                    sel.insertAdjacentHTML('beforeend', `<option value="${data.id}">${data.name}</option>`);
                });

                const row = createRow(itemIndex);
                document.getElementById('items').appendChild(row);
                const newSelect = row.querySelector('.item-select');
                newSelect.value = data.id;
                fetchUnits(newSelect);
                itemIndex++;

                document.getElementById('new-item-name').value = '';
                document.getElementById('new-item-receiving-unit').value = '';
                document.getElementById('new-item-receiving-factor').value = '1';
                document.getElementById('new-item-transfer-unit').value = '';
                document.getElementById('new-item-transfer-factor').value = '1';
                bootstrap.Modal.getInstance(document.getElementById('newItemModal')).hide();
            }
        });
    });

    document.querySelectorAll('.item-select').forEach(sel => fetchUnits(sel));
});
</script>
{% endblock %}
