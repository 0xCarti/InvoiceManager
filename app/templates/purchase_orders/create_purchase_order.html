{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Create Purchase Order</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.vendor.label(class="form-label") }}
            {{ form.vendor(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.order_date.label(class="form-label") }}
            {{ form.order_date(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.expected_date.label(class="form-label") }}
            {{ form.expected_date(class="form-control narrow-field") }}
        </div>
        <div class="form-group">
            {{ form.delivery_charge.label(class="form-label") }}
            {{ form.delivery_charge(class="form-control narrow-field") }}
        </div>
        <h4>Items</h4>
        <button id="quick-add-item" type="button" class="btn btn-link p-0">Create New Item</button>
        <div id="items" data-next-index="{{ form.items|length }}">
        {% for item in form.items %}
        {% set item_id = item.item.data %}
        {% set selected_name = '' %}
        {% if item_id %}
            {% set selected_name = item_lookup.get(item_id|int, '') %}
        {% endif %}
        {% set input_value = request.form.get('items-' ~ loop.index0 ~ '-item-label', selected_name) %}
        <div class="row g-2 mt-2 item-row align-items-center">
            <div class="col position-relative">
                <input type="text" name="items-{{ loop.index0 }}-item-label" class="form-control item-search" placeholder="Search for an item" autocomplete="off" value="{{ input_value }}">
                {{ item.item(class="item-id-field") }}
                <div class="list-group suggestion-list d-none position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
            </div>
            <div class="col"><select name="items-{{ loop.index0 }}-unit" class="form-control unit-select" data-selected="{{ item.unit.data or '' }}"></select></div>
            <div class="col">{{ item.quantity(class="form-control quantity") }}</div>
            <div class="col-auto">
                <button type="button" class="btn btn-danger remove-item">Remove</button>
            </div>
        </div>
        {% endfor %}
        </div>
        <button id="add-item" type="button" class="btn btn-secondary mt-3">Add Item</button>
        <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>

    <div class="modal fade" id="newItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-item-name" class="form-label">Name</label>
                        <input type="text" id="new-item-name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="new-item-gl-code" class="form-label">Purchase GL Code</label>
                        <select id="new-item-gl-code" class="form-select">
                            {% for code in gl_codes %}
                                <option value="{{ code.id }}">{{ code.code }}{% if code.description %} - {{ code.description }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new-item-base-unit" class="form-label">Base Unit</label>
                        <select id="new-item-base-unit" class="form-select">
                            <option value="ounce">Ounce</option>
                            <option value="gram">Gram</option>
                            <option value="each" selected>Each</option>
                            <option value="millilitre">Millilitre</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Units of Measure</label>
                        <div id="new-item-units" class="d-flex flex-column gap-2"></div>
                        <button type="button" id="add-new-item-unit" class="btn btn-outline-secondary btn-sm mt-2">Add Unit</button>
                        <div class="form-text">Configure unit conversions and choose the defaults for receiving and transfers.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="save-new-item" class="btn btn-primary">Save Item</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/purchase_order_form.js') }}"></script>
<script nonce="{{ csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    initPurchaseOrderForm({
        container: document.getElementById('items'),
        addRowButton: document.getElementById('add-item'),
        quickAddButton: document.getElementById('quick-add-item'),
        newItemModal: document.getElementById('newItemModal'),
        saveNewItemButton: document.getElementById('save-new-item'),
        nextIndex: {{ form.items|length }}
    });
});
</script>
{% endblock %}
