{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Create Purchase Order</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.vendor.label(class="form-label") }}
            {{ form.vendor(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.order_date.label(class="form-label") }}
            {{ form.order_date(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.expected_date.label(class="form-label") }}
            {{ form.expected_date(class="form-control") }}
        </div>
        <div class="form-group">
            {{ form.delivery_charge.label(class="form-label") }}
            {{ form.delivery_charge(class="form-control") }}
        </div>
        <h4>Items</h4>
        <div id="items">
        {% for item in form.items %}
        <div class="form-row mt-2">
            <div class="col">{{ item.product(class="form-control") }}</div>
            <div class="col">{{ item.unit(class="form-control") }}</div>
            <div class="col">{{ item.item(class="form-control") }}</div>
            <div class="col">{{ item.quantity(class="form-control") }}</div>
            <div class="col-auto">
                {% if loop.index0 > 0 %}
                <button type="button" class="btn btn-danger remove-item">Remove</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        </div>
        <button id="add-item" type="button" class="btn btn-secondary mt-3">Add Item</button>
        <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>
</div>

<script>
    const productOptions = `{% for val, label in form.items[0].product.choices %}<option value="{{ val }}">{{ label }}</option>{% endfor %}`;
    const unitOptions = `{% for val, label in form.items[0].unit.choices %}<option value="{{ val }}">{{ label }}</option>{% endfor %}`;
    const itemOptions = `{% for val, label in form.items[0].item.choices %}<option value="{{ val }}">{{ label }}</option>{% endfor %}`;
    let itemIndex = {{ form.items|length }};
    document.getElementById('add-item').addEventListener('click', function(e) {
        e.preventDefault();
        const row = document.createElement('div');
        row.classList.add('form-row','mt-2');
        row.innerHTML = `
            <div class="col"><select name="items-${itemIndex}-product" class="form-control">${productOptions}</select></div>
            <div class="col"><select name="items-${itemIndex}-unit" class="form-control">${unitOptions}</select></div>
            <div class="col"><select name="items-${itemIndex}-item" class="form-control">${itemOptions}</select></div>
            <div class="col"><input type="number" step="any" name="items-${itemIndex}-quantity" class="form-control"></div>
            <div class="col-auto"><button type="button" class="btn btn-danger remove-item">Remove</button></div>
        `;
        document.getElementById('items').appendChild(row);
        itemIndex++;
    });

    document.getElementById('items').addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-item')) {
            e.target.closest('.form-row').remove();
        }
    });
</script>
</div>
{% endblock %}
