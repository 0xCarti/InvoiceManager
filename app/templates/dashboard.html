{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="mb-0">Dashboard</h1>
            <p class="text-muted mb-0">A quick overview of transfer activity, purchases, invoices, and events.</p>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Transfers</h5>
                    <p class="mb-1"><strong>Total:</strong> {{ context.transfers.total }}</p>
                    <p class="mb-1"><strong>Completed:</strong> {{ context.transfers.completed }}</p>
                    <p class="mb-0"><strong>Pending:</strong> {{ context.transfers.pending }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Purchase Orders</h5>
                    <p class="mb-1"><strong>Open:</strong> {{ context.purchase_orders.open_count }}</p>
                    <p class="mb-1"><strong>Overdue:</strong> {{ context.purchase_orders.overdue_count }}</p>
                    <p class="mb-0"><strong>Expected Total:</strong> ${{ '%.2f'|format(context.purchase_orders.expected_total) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Purchase Invoices</h5>
                    <p class="mb-1"><strong>Received:</strong> {{ context.purchase_invoices.count }}</p>
                    <p class="mb-0"><strong>Total Spend:</strong> ${{ '%.2f'|format(context.purchase_invoices.total) }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Invoices</h5>
                    <p class="mb-1"><strong>Issued:</strong> {{ context.invoices.count }}</p>
                    <p class="mb-0"><strong>Invoice Total:</strong> ${{ '%.2f'|format(context.invoices.total) }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Events</h5>
                    <p class="mb-1"><strong>Active:</strong> {{ context.events.active_count }}</p>
                    <p class="mb-1"><strong>Upcoming:</strong> {{ context.events.upcoming_count }}</p>
                    {% if context.events.next_event %}
                        <p class="mb-0"><strong>Next:</strong> {{ context.events.next_event.name }} ({{ context.events.next_event.start_date.strftime('%Y-%m-%d') }} - {{ context.events.next_event.end_date.strftime('%Y-%m-%d') }})</p>
                    {% else %}
                        <p class="mb-0 text-muted">No upcoming events scheduled.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Quick Transfer Forms</h5>
                    <p class="text-muted">Use these forms to prepare transfers without leaving the dashboard.</p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            {{ form.hidden_tag() }}
                            {{ form.submit(class_="btn btn-primary w-100", value="Start Transfer") }}
                        </div>
                        <div class="col-md-4">
                            {{ add_form.hidden_tag() }}
                            {{ add_form.submit(class_="btn btn-outline-primary w-100", value="Add Transfer") }}
                        </div>
                        <div class="col-md-4">
                            {{ edit_form.hidden_tag() }}
                            {{ edit_form.submit(class_="btn btn-outline-secondary w-100", value="Edit Transfer") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-12">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3">
                        <div>
                            <h5 class="card-title mb-1">Action queues</h5>
                            <p class="text-muted mb-0">Stay ahead on receipts, approvals, and vendor payments.</p>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-lg-4">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Pending purchase orders</h6>
                                    {% if context.queues.purchase_orders.total > context.queues.purchase_orders.items|length %}
                                        <a class="small" href="{{ url_for('purchase.view_purchase_orders') }}">Show more</a>
                                    {% endif %}
                                </div>
                                <ul class="list-group list-group-flush">
                                    {% for po in context.queues.purchase_orders.items %}
                                        {% set vendor_label = po.vendor_name or (po.vendor and (po.vendor.first_name ~ ' ' ~ po.vendor.last_name)) or 'Unknown vendor' %}
                                        <li class="list-group-item px-0">
                                            <div class="d-flex justify-content-between align-items-start gap-3">
                                                <div>
                                                    <div class="fw-semibold">{{ vendor_label }}</div>
                                                    <div class="text-muted small">Due {{ po.expected_date.strftime('%b %d, %Y') }} · ${{ '%.2f'|format(po.expected_total_cost or 0) }}</div>
                                                </div>
                                                <div class="text-end">
                                                    <a class="btn btn-sm btn-primary" href="{{ url_for('purchase.receive_invoice', po_id=po.id) }}">Receive</a>
                                                </div>
                                            </div>
                                        </li>
                                    {% else %}
                                        <li class="list-group-item px-0 text-muted">No pending purchase orders.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Transfers awaiting approval</h6>
                                    {% if context.queues.transfers.total > context.queues.transfers.items|length %}
                                        <a class="small" href="{{ url_for('transfer.view_transfers') }}">Show more</a>
                                    {% endif %}
                                </div>
                                <ul class="list-group list-group-flush">
                                    {% for transfer in context.queues.transfers.items %}
                                        <li class="list-group-item px-0">
                                            <div class="d-flex justify-content-between align-items-start gap-3">
                                                <div>
                                                    <div class="fw-semibold">{{ transfer.from_location_name or transfer.from_location.name }} → {{ transfer.to_location_name or transfer.to_location.name }}</div>
                                                    <div class="text-muted small">Created {{ transfer.date_created.strftime('%b %d, %Y') }}</div>
                                                </div>
                                                <div class="text-end d-flex flex-column align-items-end gap-1">
                                                    <form method="post" action="{{ url_for('transfer.complete_transfer', transfer_id=transfer.id) }}" class="d-inline">
                                                        {{ confirm_form.hidden_tag() }}
                                                        <button type="submit" class="btn btn-sm btn-success">Approve</button>
                                                    </form>
                                                    <a class="small" href="{{ url_for('transfer.view_transfer', transfer_id=transfer.id) }}">Review</a>
                                                </div>
                                            </div>
                                        </li>
                                    {% else %}
                                        <li class="list-group-item px-0 text-muted">No transfers awaiting approval.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Invoices to post/pay</h6>
                                    {% if context.queues.purchase_invoices.total > context.queues.purchase_invoices.items|length %}
                                        <a class="small" href="{{ url_for('purchase.view_purchase_invoices') }}">Show more</a>
                                    {% endif %}
                                </div>
                                <ul class="list-group list-group-flush">
                                    {% for invoice in context.queues.purchase_invoices.items %}
                                        {% set vendor_label = invoice.vendor_name or (invoice.purchase_order and invoice.purchase_order.vendor and (invoice.purchase_order.vendor.first_name ~ ' ' ~ invoice.purchase_order.vendor.last_name)) or 'Unknown vendor' %}
                                        {% set location_label = invoice.location_name or (invoice.location and invoice.location.name) or 'Unassigned location' %}
                                        <li class="list-group-item px-0">
                                            <div class="d-flex justify-content-between align-items-start gap-3">
                                                <div>
                                                    <div class="fw-semibold">{{ vendor_label }}</div>
                                                    <div class="text-muted small">{{ location_label }} · {{ invoice.received_date.strftime('%b %d, %Y') }} · ${{ '%.2f'|format(invoice.total) }}</div>
                                                </div>
                                                <div class="text-end">
                                                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('purchase.view_purchase_invoice', invoice_id=invoice.id) }}">Post/Pay</a>
                                                </div>
                                            </div>
                                        </li>
                                    {% else %}
                                        <li class="list-group-item px-0 text-muted">No invoices awaiting posting or payment.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-12">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3">
                        <div>
                            <h5 class="card-title mb-1">Event Schedule</h5>
                            <p class="text-muted mb-0">Browse upcoming and active events; overdue dates are highlighted.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a class="btn btn-primary" href="{{ url_for('event.create_event') }}">Schedule event</a>
                            <a class="btn btn-outline-danger" href="{{ url_for('event.view_events') }}">Close event</a>
                        </div>
                    </div>
                    <div class="row g-3 mt-3">
                        <div class="col-lg-4">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">{{ context.events.schedule.calendar.month_label }}</h6>
                                    <span class="badge bg-light text-body-secondary">Today: {{ context.events.schedule.calendar.today.strftime('%b %d') }}</span>
                                </div>
                                <p class="small text-muted mb-2">Click a date badge to filter the event list.</p>
                                <div class="d-grid gap-2 event-calendar-grid" style="grid-template-columns: repeat(7, minmax(0, 1fr));">
                                    {% for day in context.events.schedule.calendar.days %}
                                        {% set has_events = day.count > 0 %}
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary text-start event-calendar-day"
                                            data-date="{{ day.date.isoformat() }}"
                                            data-label="{{ day.date.strftime('%b %d') }}"
                                            {% if day.date == context.events.schedule.calendar.today %}data-today="true"{% endif %}
                                            {% if not has_events %}data-empty="true"{% endif %}
                                        >
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="fw-semibold">{{ day.day }}</span>
                                                {% if has_events %}
                                                    <span class="badge bg-primary">{{ day.count }}</span>
                                                {% else %}
                                                    <span class="text-muted small">–</span>
                                                {% endif %}
                                            </div>
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="border rounded p-3 h-100 d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Upcoming events</h6>
                                    <span class="small text-muted" data-event-filter-label>Showing all events</span>
                                </div>
                                <ul class="list-group list-group-flush flex-grow-1" id="event-schedule-list">
                                    {% for ev in context.events.schedule.events %}
                                        <li class="list-group-item" data-event-row data-start-date="{{ ev.start_date.isoformat() }}" data-end-date="{{ ev.end_date.isoformat() }}">
                                            <div class="d-flex justify-content-between align-items-start gap-3">
                                                <div>
                                                    <div class="fw-semibold">{{ ev.name }}</div>
                                                    <div class="text-muted small">{{ ev.start_date.strftime('%b %d, %Y') }} – {{ ev.end_date.strftime('%b %d, %Y') }}</div>
                                                </div>
                                                <div class="text-end">
                                                    {% if ev.status == 'past_due' %}
                                                        <span class="badge bg-danger">Past close date</span>
                                                    {% elif ev.status == 'active' %}
                                                        <span class="badge bg-success">Active</span>
                                                    {% else %}
                                                        <span class="badge bg-primary">Upcoming</span>
                                                    {% endif %}
                                                    <div>
                                                        <a class="small" href="{{ url_for('event.view_event', event_id=ev.id) }}">View</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    {% else %}
                                        <li class="list-group-item text-muted">No upcoming events scheduled.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script nonce="{{ csp_nonce }}">
        document.addEventListener('DOMContentLoaded', () => {
            const calendarButtons = Array.from(document.querySelectorAll('.event-calendar-day'));
            const eventRows = Array.from(document.querySelectorAll('[data-event-row]'));
            const filterLabel = document.querySelector('[data-event-filter-label]');
            let selectedDate = '';

            function updateFilter(dateValue, label) {
                selectedDate = dateValue;
                calendarButtons.forEach((btn) => {
                    btn.classList.toggle('active', btn.dataset.date === selectedDate);
                    if (btn.dataset.today === 'true') {
                        btn.classList.toggle('btn-outline-primary', btn.dataset.date === selectedDate);
                    }
                });

                eventRows.forEach((row) => {
                    const start = row.dataset.startDate;
                    const end = row.dataset.endDate;
                    const matches = !selectedDate || (start <= selectedDate && selectedDate <= end);
                    row.classList.toggle('d-none', !matches);
                });

                if (filterLabel) {
                    filterLabel.textContent = selectedDate ? `Showing events on ${label}` : 'Showing all events';
                }
            }

            calendarButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.empty === 'true') {
                        return;
                    }
                    const isSameSelection = btn.dataset.date === selectedDate;
                    const newDate = isSameSelection ? '' : btn.dataset.date;
                    const label = isSameSelection ? '' : btn.dataset.label;
                    updateFilter(newDate, label || '');
                });
            });
        });
    </script>
{% endblock %}
