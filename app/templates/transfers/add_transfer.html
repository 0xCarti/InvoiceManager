{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Add New Transfer</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.from_location_id.label(class="form-label") }}
                    {{ form.from_location_id(class="form-control") }}
                    {% for error in form.from_location_id.errors %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.to_location_id.label(class="form-label") }}
                    {{ form.to_location_id(class="form-control") }}
                    {% for error in form.to_location_id.errors %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <h3>Add Items</h3>
        <div class="form-group">
            <label for="item-name" class="form-label">Item Name</label>
            <input type="text" id="item-name" class="form-control" name="item-name" autocomplete="off">
            <div id="suggestions"></div>
        </div>
        <div id="item-list" class="mb-3"></div>
        {{ form.submit(class="btn btn-success") }}
    </form>
</div>
<script nonce="{{ csp_nonce }}">
    document.getElementById('item-name').addEventListener('input', function() {
        var input = this.value;
        if (input === ''){
            document.getElementById('suggestions').innerHTML = '';
            return;
        }
        // Make AJAX request to fetch item suggestions based on input
        fetch('/items/search?term=' + input)
            .then(response => response.json())
            .then(data => {
                var suggestionsDiv = document.getElementById('suggestions');
                suggestionsDiv.innerHTML = '';
                data.forEach(function(item) {
                    var suggestion = document.createElement('div');
                    suggestion.textContent = item.name; // Display the item name
                    suggestion.dataset.id = item.id; // Store the item ID in a data attribute
                    suggestion.classList.add('suggestion');
                    suggestionsDiv.appendChild(suggestion);
                });
            })
            .catch(error => {
                console.error('Error fetching item suggestions:', error);
            });
    });

    let itemIndex = 0;

    document.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('suggestion')) {
            var itemName = event.target.textContent; // Get the item name from textContent
            var itemId = event.target.dataset.id; // Get the item ID from data attribute
            addItemToList({id: itemId, name: itemName}); // Pass an object with both id and name
        }
    });

    function addItemToList(item) {
        fetch(`/items/${item.id}/units`).then(r => r.json()).then(data => {
            const base = data.base_unit;
            const units = data.units || [];
            const hasDefault = units.some(u => u.transfer_default);
            units.unshift({id:0, name: base, factor:1, transfer_default: !hasDefault});
            var options = '';
            units.forEach(u => {
                const label = u.id === 0 ? base : `${u.name} of ${u.factor} ${base}${u.factor != 1 ? 's' : ''}`;
                options += `<option value="${u.id}" data-factor="${u.factor}" ${u.transfer_default ? 'selected' : ''}>${label}</option>`;
            });
            var listItem = document.createElement('div');
            listItem.classList.add('item-container', 'd-flex', 'justify-content-between', 'align-items-center', 'mb-2');

            // Left column: item name
            var nameDiv = document.createElement('div');
            nameDiv.style.paddingLeft = '15px';
            nameDiv.style.fontWeight = 'bold';
            nameDiv.textContent = item.name;

            // Right column: controls
            var controlsDiv = document.createElement('div');
            controlsDiv.className = 'd-flex align-items-center';

            var inputHidden = document.createElement('input');
            inputHidden.type = 'hidden';
            inputHidden.name = `items-${itemIndex}-item`;
            inputHidden.value = item.id;

            var selectUnit = document.createElement('select');
            selectUnit.name = `items-${itemIndex}-unit`;
            selectUnit.className = 'form-control me-2';
            selectUnit.style.maxWidth = '160px';
            units.forEach(u => {
                const label = u.id === 0 ? base : `${u.name} of ${u.factor} ${base}${u.factor != 1 ? 's' : ''}`;
                var opt = document.createElement('option');
                opt.value = u.id;
                opt.setAttribute('data-factor', u.factor);
                if (u.transfer_default) opt.selected = true;
                opt.textContent = label;
                selectUnit.appendChild(opt);
            });

            var inputQty = document.createElement('input');
            inputQty.type = 'number';
            inputQty.step = 'any';
            inputQty.className = 'form-control quantity';
            inputQty.name = `items-${itemIndex}-quantity`;
            inputQty.placeholder = 'Qty';
            inputQty.style.maxWidth = '120px';
            inputQty.dataset.baseQty = "0";

            var btnDelete = document.createElement('button');
            btnDelete.type = 'button';
            btnDelete.className = 'btn btn-danger delete-item ml-2';
            btnDelete.textContent = 'Delete';

            controlsDiv.appendChild(inputHidden);
            controlsDiv.appendChild(selectUnit);
            controlsDiv.appendChild(inputQty);
            controlsDiv.appendChild(btnDelete);

            listItem.appendChild(nameDiv);
            listItem.appendChild(controlsDiv);

            inputQty.addEventListener('input', function(){
                const factor = parseFloat(selectUnit.selectedOptions[0].dataset.factor);
                this.dataset.baseQty = (parseFloat(this.value) || 0) * factor;
            });
            selectUnit.addEventListener('change', function(){
                const factor = parseFloat(this.selectedOptions[0].dataset.factor);
                inputQty.value = (parseFloat(inputQty.dataset.baseQty) || 0) / factor;
            });
            document.getElementById('item-list').appendChild(listItem);
            document.getElementById('suggestions').innerHTML = '';
            document.getElementById('item-name').value = '';
            itemIndex++;
        });
    }



        document.getElementById('item-list').addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('delete-item')) {
                event.target.closest('.item-container').remove();
            }
        });
</script>
{% endblock %}
