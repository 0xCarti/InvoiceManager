{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Edit Transfer</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.from_location_id.label(class="form-label") }}
                    {{ form.from_location_id(class="form-control") }}
                    {% for error in form.from_location_id.errors %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.to_location_id.label(class="form-label") }}
                    {{ form.to_location_id(class="form-control") }}
                    {% for error in form.to_location_id.errors %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <h3>Add Items</h3>
        <div class="form-group">
            <label for="item-name" class="form-label">Item Name</label>
            <input type="text" id="item-name" class="form-control" name="item-name" autocomplete="off">
            <div id="suggestions"></div>
        </div>
        <div id="item-list" class="mb-3"></div>
        {{ form.submit(class="btn btn-success") }}
    </form>
</div>
<script nonce="{{ csp_nonce }}">
    let itemIndex = 0;
    window.addEventListener('DOMContentLoaded', (event) => {
    const existingItems = {{ items | tojson | safe }};
    existingItems.forEach((item, index) => {
        addItemToList(item, index);
    });
    itemIndex = existingItems.length;
});


document.getElementById('item-name').addEventListener('input', function() {
    var input = this.value;
    if (input === ''){
        document.getElementById('suggestions').innerHTML = '';
        return;
    }
    // Make AJAX request to fetch item suggestions based on input
    fetch('/items/search?term=' + input)
        .then(response => response.json())
        .then(data => {
            var suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            data.forEach(function(item) {
                var suggestion = document.createElement('div');
                suggestion.textContent = item.name; // Display the item name
                suggestion.dataset.id = item.id; // Store the item ID in a data attribute
                suggestion.classList.add('suggestion');
                suggestionsDiv.appendChild(suggestion);
            });
        })
        .catch(error => {
            console.error('Error fetching item suggestions:', error);
        });
});

document.addEventListener('click', function(event) {
    if (event.target && event.target.classList.contains('suggestion')) {
        var itemName = event.target.textContent; // Get the item name from textContent
        var itemId = event.target.dataset.id; // Get the item ID from data attribute
        addItemToList({id: itemId, name: itemName}, itemIndex);
        itemIndex++;
    }
});

function addItemToList(item, index) {
    fetch(`/items/${item.id}/units`).then(r => r.json()).then(data => {
        const base = data.base_unit;
        const units = data.units || [];
        const hasDefault = units.some(u => u.transfer_default);
        units.unshift({id:0, name: base, factor:1, transfer_default: !hasDefault});
        let defaultUnit = units.find(u => u.transfer_default) || units[0];
        var options = '';
        units.forEach(u => {
            const label = u.id === 0 ? base : `${u.name} of ${u.factor} ${base}${u.factor != 1 ? 's' : ''}`;
            const selected = u.id === defaultUnit.id ? 'selected' : '';
            options += `<option value="${u.id}" data-factor="${u.factor}" ${selected}>${label}</option>`;
        });
        var listItem = document.createElement('div');
        listItem.classList.add('item-container', 'd-flex', 'justify-content-between', 'align-items-center', 'mb-2');
        const displayQty = item.quantity ? item.quantity / defaultUnit.factor : 0;
        // Use DOM API to safely inject item.name.
        // Create left (name) section
        const nameDiv = document.createElement('div');
        nameDiv.style.paddingLeft = '15px';
        nameDiv.style.fontWeight = 'bold';
        nameDiv.textContent = item.name;
        // Create right (form section) div
        const rightDiv = document.createElement('div');
        rightDiv.className = 'd-flex align-items-center';
        // Hidden input for item id
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `items-${index}-item`;
        hiddenInput.value = item.id;
        // Select (units options)
        const select = document.createElement('select');
        select.name = `items-${index}-unit`;
        select.className = 'form-control me-2';
        select.style.maxWidth = '160px';
        select.innerHTML = options;
        // Quantity input
        const qtyInputEl = document.createElement('input');
        qtyInputEl.type = 'number';
        qtyInputEl.step = 'any';
        qtyInputEl.className = 'form-control quantity';
        qtyInputEl.name = `items-${index}-quantity`;
        qtyInputEl.value = displayQty;
        qtyInputEl.placeholder = 'Qty';
        qtyInputEl.style.maxWidth = '120px';
        qtyInputEl.dataset.baseQty = item.quantity;
        // Delete button
        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'btn btn-danger delete-item mx-2';
        delBtn.textContent = 'Delete';
        // Append controls to rightDiv
        rightDiv.appendChild(hiddenInput);
        rightDiv.appendChild(select);
        rightDiv.appendChild(qtyInputEl);
        rightDiv.appendChild(delBtn);
        // Now build final listItem
        listItem.appendChild(nameDiv);
        listItem.appendChild(rightDiv);
        qtyInputEl.addEventListener('input', function(){
            const factor = parseFloat(select.selectedOptions[0].dataset.factor);
            this.dataset.baseQty = (parseFloat(this.value) || 0) * factor;
        });
        select.addEventListener('change', function(){
            const factor = parseFloat(this.selectedOptions[0].dataset.factor);
            const qty = qtyInputEl;
            qty.value = (parseFloat(qty.dataset.baseQty) || 0) / factor;
        });
        document.getElementById('item-list').appendChild(listItem);
    });
}

    document.getElementById('item-list').addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('delete-item')) {
            event.target.closest('.item-container').remove();
        }
    });
</script>
{% endblock %}
