{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Edit Transfer</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.from_location_id.label(class="form-label") }}
                    {{ form.from_location_id(class="form-control") }}
                    {% for error in form.from_location_id.errors %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.to_location_id.label(class="form-label") }}
                    {{ form.to_location_id(class="form-control") }}
                    {% for error in form.to_location_id.errors %}
                    <div class="alert alert-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <h3>Add Items</h3>
        <div class="form-group">
            <label for="item-name" class="form-label">Item Name</label>
            <input type="text" id="item-name" class="form-control" name="item-name" autocomplete="off">
            <div id="suggestions"></div>
        </div>
        <div id="item-list" class="mb-3"></div>
        {{ form.submit(class="btn btn-success") }}
    </form>
</div>
<script>
    let itemIndex = 0;
    window.addEventListener('DOMContentLoaded', (event) => {
    const existingItems = {{ items | tojson | safe }};
    existingItems.forEach((item, index) => {
        addItemToList(item, index);
    });
    itemIndex = existingItems.length;
});


document.getElementById('item-name').addEventListener('input', function() {
    var input = this.value;
    if (input === ''){
        document.getElementById('suggestions').innerHTML = '';
        return;
    }
    // Make AJAX request to fetch item suggestions based on input
    fetch('/items/search?term=' + input)
        .then(response => response.json())
        .then(data => {
            var suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            data.forEach(function(item) {
                var suggestion = document.createElement('div');
                suggestion.textContent = item.name; // Display the item name
                suggestion.dataset.id = item.id; // Store the item ID in a data attribute
                suggestion.classList.add('suggestion');
                suggestionsDiv.appendChild(suggestion);
            });
        })
        .catch(error => {
            console.error('Error fetching item suggestions:', error);
        });
});

document.addEventListener('click', function(event) {
    if (event.target && event.target.classList.contains('suggestion')) {
        var itemName = event.target.textContent; // Get the item name from textContent
        var itemId = event.target.dataset.id; // Get the item ID from data attribute
        addItemToList({id: itemId, name: itemName}, itemIndex);
        itemIndex++;
    }
});

function addItemToList(item, index) {
    fetch(`/items/${item.id}/units`).then(r => r.json()).then(data => {
        const base = data.base_unit;
        const units = data.units || [];
        const hasDefault = units.some(u => u.transfer_default);
        units.unshift({id:0, name: base, factor:1, transfer_default: !hasDefault});
        let defaultUnit = units.find(u => u.transfer_default) || units[0];
        var options = '';
        units.forEach(u => {
            const label = u.id === 0 ? base : `${u.name} of ${u.factor} ${base}${u.factor != 1 ? 's' : ''}`;
            const selected = u.id === defaultUnit.id ? 'selected' : '';
            options += `<option value="${u.id}" data-factor="${u.factor}" ${selected}>${label}</option>`;
        });
        var listItem = document.createElement('div');
        listItem.classList.add('item-container', 'd-flex', 'justify-content-between', 'align-items-center', 'mb-2');
        const displayQty = item.quantity ? item.quantity / defaultUnit.factor : 0;
        listItem.innerHTML = `
            <div style="padding-left: 15px; font-weight: bold;">${item.name}</div>
            <div class="d-flex align-items-center">
                <input type="hidden" name="items-${index}-item" value="${item.id}">
                <select name="items-${index}-unit" class="form-control me-2" style="max-width: 160px;">${options}</select>
                <input type="number" step="any" class="form-control quantity" name="items-${index}-quantity" value="${displayQty}" placeholder="Qty" style="max-width: 120px;" data-base-qty="${item.quantity}">
                <button type="button" class="btn btn-danger delete-item mx-2">Delete</button>
            </div>
        `;
        const qtyInput = listItem.querySelector('.quantity');
        const unitSelect = listItem.querySelector('select');
        qtyInput.addEventListener('input', function(){
            const factor = parseFloat(unitSelect.selectedOptions[0].dataset.factor);
            this.dataset.baseQty = (parseFloat(this.value) || 0) * factor;
        });
        unitSelect.addEventListener('change', function(){
            const factor = parseFloat(this.selectedOptions[0].dataset.factor);
            const qty = listItem.querySelector('.quantity');
            qty.value = (parseFloat(qty.dataset.baseQty) || 0) / factor;
        });
        document.getElementById('item-list').appendChild(listItem);
    });
}

    document.getElementById('item-list').addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('delete-item')) {
            event.target.closest('.item-container').remove();
        }
    });
</script>
{% endblock %}
